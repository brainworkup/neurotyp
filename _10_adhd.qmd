---
title-meta: adhd
execute:
  warning: false
  echo: false
  message: false
format:
  typst:
    keep-typ: true
  pdf:
    keep-md: true
    keep-tex: true
params:
  pheno: adhd
---

<!-- ## ADHD/Executive Functioning -->

{{< include _10_adhd_text.qmd >}}

```{r}
#| label: setup
xfun::pkg_attach2(c(
  "gt",
  "dplyr",
  "glue",
  "webshot2",
  "ggplot2",
  "ggthemes",
  "scales",
  "bwu"
))
```

```{r}
#| label: data-adhd
data <- bwu::read_data(pheno = "adhd")
```

```{r}
#| label: filter-adhd
filter_file <- c(
  "Action",
  "Activation",
  "ADHD Index",
  "Attention",
  "CAARS-OR ADHD Index",
  "CAARS-OR DSM-5 ADHD Symptoms Total",
  "CAARS-OR DSM-5 Hyperactive-Impulsive Symptoms",
  "CAARS-OR DSM-5 Inattentive Symptoms",
  "CAARS-OR Hyperactivity/Restlessness",
  "CAARS-OR Impulsivity/Emotional Lability",
  "CAARS-OR Inattention/Memory Problems",
  "CAARS-OR Problems with Self-Concept",
  "CAARS-SR ADHD Index",
  "CAARS-SR DSM-5 ADHD Symptoms Total",
  "CAARS-SR DSM-5 Hyperactive-Impulsive Symptoms",
  "CAARS-SR DSM-5 Inattentive Symptoms",
  "CAARS-SR Hyperactivity/Restlessness",
  "CAARS-SR Impulsivity/Emotional Lability",
  "CAARS-SR Inattention/Memory Problems",
  "CAARS-SR Problems with Self-Concept",
  "CEFI-OR Attention",
  "CEFI-OR Emotion Regulation",
  "CEFI-OR Flexibility",
  "CEFI-OR Full Scale",
  "CEFI-OR Inhibitory Control",
  "CEFI-OR Initiation",
  "CEFI-OR Organization",
  "CEFI-OR Planning",
  "CEFI-OR Self-Monitoring",
  "CEFI-OR Working Memory",
  "CEFI-SR Attention",
  "CEFI-SR Emotion Regulation",
  "CEFI-SR Flexibility",
  "CEFI-SR Full Scale",
  "CEFI-SR Inhibitory Control",
  "CEFI-SR Initiation",
  "CEFI-SR Organization",
  "CEFI-SR Planning",
  "CEFI-SR Self-Monitoring",
  "CEFI-SR Working Memory",
  "DSM-5 ADHD Symptoms Total",
  "DSM-5 Hyperactive-Impulsive Symptoms",
  "DSM-5 Inattentive Symptoms",
  "Effort",
  "Emotion Regulation",
  "Emotion",
  "Flexibility",
  "Focus",
  "Full Scale",
  "Hyperactivity/Restlessness",
  "Impulsivity/Emotional Lability",
  "Inattention/Memory Problems",
  "Inhibitory Control",
  "Initiation",
  "Memory",
  "Organization",
  "Planning",
  "Problems with Self-Concept",
  "Self-Monitoring",
  "Total Composite",
  "Working Memory"
)
data_adhd <- bwu::filter_domain(data, domain = "ADHD", filter_file = filter_file)
data_ef <- bwu::filter_domain(data,
  domain = "Executive Functioning",
  filter_file = filter_file
)
data <- dplyr::bind_rows(data_adhd, data_ef)
```


```{r}
#| label: text-adhd
#| cache: true
bwu::flatten_scale_text(data, file = "_10_adhd_raw.qmd")
```

```{r}
#| label: text-adhd-sr
#| cache: true
# Self-report
data_sr <-
  data |>
  dplyr::filter(test == "cefi_sr" | test == "caars_sr") |>
  dplyr::arrange(dplyr::desc(percentile)) |>
  dplyr::distinct(.keep_all = FALSE)
flatten_scale_text <- function(data, file) {
  cat(
    paste0(data$result),
    file = file,
    sep = "\n",
    append = TRUE
  )
}
flatten_scale_text(data = data_sr, file = "_10_adhd_raw.qmd")
```

```{r}
#| label: text-adhd-or
#| cache: true
# Observer reports
data_or <-
  data |>
  dplyr::filter(test == "cefi_or" | test == "caars_or") |>
  dplyr::arrange(dplyr::desc(percentile)) |>
  dplyr::distinct(.keep_all = FALSE)
flatten_scale_text <- function(data, file) {
  cat(
    paste0(data$result),
    file = file,
    sep = "\n",
    append = TRUE
  )
}
flatten_scale_text(data = data_or, file = "_10_adhd_raw.qmd")
```

```{r}
#| label: qtbl-adhd
#| dev: tikz
#| fig-process: pdf2png
options(tikzDefaultEngine = "xetex")
# source note
source_note <- gt::md("*Note:* CAARS Standard scores have a mean of 50 and a standard deviation of 10, and higher scores reflect reduced functioning.

CEFI Standard scores have a mean of 100 and a standard deviation of 15, and lower scores reflect reduced functioning.")
table_name <- "table_adhd"
pheno <- "adhd"
bwu::make_tbl_gt(data, pheno = pheno, source_note = source_note, table_name = table_name)
```


```{=typst}
#let domain = "ADHD/Executive Functioning"
<qtbl-adhd>
#figure([#image("table_adhd.png", width: 50%)],
  caption: [
    #domain Test Scores
  ],
  kind: "qtbl",
  supplement: [Table],
)
```

```{r}
#| label: fig-adhd
#| out-width: 70%
#| fig-height: 7
#| fig-cap: "Attention and executive functions are multidimensional concepts that contain several related processes. Both concepts require self-regulatory skills and have some common subprocesses; therefore, it is common to treat them together, or even to refer to both processes when talking about one or the other."
#| fig-subcap: "ADHD Subdomain Plots"
xfun::pkg_attach(c(
  "gt", "tidyverse", "glue", "webshot2", "ggplot2", "ggthemes",
  "scales", "bwu", "patchwork"
))
roma <- c(
  "#7E1700", "#893107", "#934610", "#9C5717", "#A5681F", "#AD7A27",
  "#B58B31", "#BF9F40", "#C7B354", "#CFC970", "#D2DA90", "#CDE5AC",
  "#C0E9C2", "#ACE7D0", "#93DFD5", "#77D1D7", "#5DC0D2", "#47AECD",
  "#389CC6", "#2F8CBF", "#277AB8", "#2169B0", "#1C58A9", "#1345A0",
  "#023198"
)
# data for caars dotplot
pheno <- "caars"
data_caars <- dplyr::filter(data, filename %in% c("caars_sr.csv", "caars_or.csv"))
fig_caars <- bwu::make_fig(
  data = data_caars,
  pheno = pheno,
  x = data_caars$z_mean_subdomain,
  y = data_caars$subdomain,
  colors = roma
)
# data for cefi dotplot
pheno <- "cefi"
data_cefi <- dplyr::filter(data, filename %in% c("cefi_sr.csv", "cefi_or.csv"))
fig_cefi <- bwu::make_fig(
  data = data_cefi,
  pheno = pheno,
  x = data_cefi$z_mean_subdomain,
  y = data_cefi$subdomain,
  colors = roma
)
# combine plots
pathwork <- fig_caars / fig_cefi
pathwork +
  plot_annotation()
```
