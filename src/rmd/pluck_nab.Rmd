---
title: |
  <center> NAB Main Modules: </center>
  <center> Comprehensive Score Report </center>
date: "`r Sys.Date()`"
params:
  patient: Reiner
  test: nab
  test_name: NAB
  pages: [2, 3, 6, 9, 10, 10, 11, 13, 16]
  file:
    label: No file selected
    value: file
    input: file
  table1:
    label: NAB Index Score Summary Table
    value:
      - Attention Index (ATT)
      - Language Index (LAN)
      - Memory Index (MEM)
      - Spatial Index (SPT)
      - Executive Functions Index (EXE)
      - Total NAB Index (T-NAB)
    input: select
    multiple: yes
    choices:
      - Attention Index (ATT)
      - Language Index (LAN)
      - Memory Index (MEM)
      - Spatial Index (SPT)
      - Executive Functions Index (EXE)
      - Total NAB Index (T-NAB)
  table2:
    label: Attention Module Score Table
    value:
      - Orientation
      - Orientation to Self
      - Orientation to Time
      - Orientation to Place
      - Orientation to Situation
      - Digits Forward
      - Digits Forward Longest Span
      - Digits Backward
      - Digits Backward Longest Span
      - Dots
      - Numbers & Letters Part A Speed
      - Numbers & Letters Part A Errors
      - Numbers & Letters Part A Efficiency
      - Numbers & Letters Part B Efficiency
      - Numbers & Letters Part C Efficiency
      - Numbers & Letters Part D Efficiency
      - Numbers & Letters Part D Disruption
      - Driving Scenes
    input: select
    multiple: yes
    choices:
      - Orientation
      - Orientation to Self
      - Orientation to Time
      - Orientation to Place
      - Orientation to Situation
      - Digits Forward
      - Digits Forward Longest Span
      - Digits Backward
      - Digits Backward Longest Span
      - Dots
      - Numbers & Letters Part A Speed
      - Numbers & Letters Part A Errors
      - Numbers & Letters Part A Efficiency
      - Numbers & Letters Part B Efficiency
      - Numbers & Letters Part C Efficiency
      - Numbers & Letters Part D Efficiency
      - Numbers & Letters Part D Disruption
      - Driving Scenes
  table3:
    label: Language Module Score Table
    value:
      - Oral Production
      - Auditory Comprehension
      - Auditory Comprehension Colors
      - Auditory Comprehension Shapes
      - Auditory Comprehension Colors/Shapes/Numbers
      - Auditory Comprehension Pointing
      - Auditory Comprehension Yes/No
      - Auditory Comprehension Paper Folding
      - Naming
      - Naming Semantic Cuing
      - Naming Phonemic Cuing
      - Reading Comprehension
      - Reading Comprehension Words
      - Reading Comprehension Sentences
      - Writing
      - Writing Legibility
      - Writing Spelling
      - Writing Syntax
      - Writing Conveyance
      - Bill Payment
    input: select
    multiple: yes
    choices:
      - Oral Production
      - Auditory Comprehension
      - Auditory Comprehension Colors
      - Auditory Comprehension Shapes
      - Auditory Comprehension Colors/Shapes/Numbers
      - Auditory Comprehension Pointing
      - Auditory Comprehension Yes/No
      - Auditory Comprehension Paper Folding
      - Naming
      - Naming Semantic Cuing
      - Naming Phonemic Cuing
      - Reading Comprehension
      - Reading Comprehension Words
      - Reading Comprehension Sentences
      - Writing
      - Writing Legibility
      - Writing Spelling
      - Writing Syntax
      - Writing Conveyance
      - Bill Payment
  table4:
    label: List Learning Score Table
    value:
      - List Learning List A Trial 1 Immediate Recall
      - List Learning List A Trial 2 Immediate Recall
      - List Learning List A Trial 3 Immediate Recall
      - List Learning List A Immediate Recall
      - List Learning List B Immediate Recall
      - List Learning List A Short Delayed Recall
      - List Learning List A Long Delayed Recall
      - Long Delayed Recall
      - List Learning List A Percent Retention
      - List Learning List A Long Delayed Forced-Choice Recognition
      - List Learning List A Long Delayed Forced-Choice Recognition False Alarms
      - List Learning List A Discriminability Index
      - List Learning List A Recall vs. Recognition Index
      - List Learning Semantic Clusters
      - List Learning Perseverations
      - List Learning Intrusions
    input: select
    multiple: yes
    choices:
      - List Learning List A Trial 1 Immediate Recall
      - List Learning List A Trial 2 Immediate Recall
      - List Learning List A Trial 3 Immediate Recall
      - List Learning List A Immediate Recall
      - List Learning List B Immediate Recall
      - List Learning List A Short Delayed Recall
      - List Learning List A Long Delayed Recall
      - Long Delayed Recall
      - List Learning List A Percent Retention
      - List Learning List A Long Delayed Forced-Choice Recognition
      - List Learning List A Long Delayed Forced-Choice Recognition False Alarms
      - List Learning List A Discriminability Index
      - List Learning List A Recall vs. Recognition Index
      - List Learning Semantic Clusters
      - List Learning Perseverations
      - List Learning Intrusions
  table5:
    label: Shape Learning Score Table
    value:
      - Shape Learning Trial 1 Immediate Recognition
      - Shape Learning Trial 2 Immediate Recognition
      - Shape Learning Trial 3 Immediate Recognition
      - Shape Learning Immediate Recognition
      - Shape Learning Delayed Recognition
      - Shape Learning Percent Retention
      - Shape Learning Delayed Forced-Choice Recognition
      - Shape Learning Delayed Forced-Choice Recognition False Alarms
      - Shape Learning Discriminability Index
    input: select
    multiple: yes
    choices:
      - Shape Learning Trial 1 Immediate Recognition
      - Shape Learning Trial 2 Immediate Recognition
      - Shape Learning Trial 3 Immediate Recognition
      - Shape Learning Immediate Recognition
      - Shape Learning Delayed Recognition
      - Shape Learning Percent Retention
      - Shape Learning Delayed Forced-Choice Recognition
      - Shape Learning Delayed Forced-Choice Recognition False Alarms
      - Shape Learning Discriminability Index
  table6:
    label: Story Learning Score Table
    value:
      - Story Learning Trial 1 Phrase Unit Immediate Recall
      - Story Learning Trial 2 Phrase Unit Immediate Recall
      - Story Learning Phrase Unit Immediate Recall
      - Story Learning Thematic Unit Immediate Recall
      - Story Learning Trial 1 Thematic Unit Immediate Recall
      - Story Learning Trial 2 Thematic Unit Immediate Recall
      - Story Learning Phrase Unit Delayed Recall
      - Story Learning Thematic Unit Delayed Recall
      - Story Learning Phrase Unit Percent Retention
    input: select
    multiple: yes
    choices:
      - Story Learning Trial 1 Phrase Unit Immediate Recall
      - Story Learning Trial 2 Phrase Unit Immediate Recall
      - Story Learning Phrase Unit Immediate Recall
      - Story Learning Thematic Unit Immediate Recall
      - Story Learning Trial 1 Thematic Unit Immediate Recall
      - Story Learning Trial 2 Thematic Unit Immediate Recall
      - Story Learning Phrase Unit Delayed Recall
      - Story Learning Thematic Unit Delayed Recall
      - Story Learning Phrase Unit Percent Retention
  table7:
    label: Daily Living Memory Score Table
    value:
      - Daily Living Memory Immediate Recall
      - Daily Living Memory Delayed Recall
      - Daily Living Memory Retention
      - Daily Living Memory Delayed Recognition
      - Daily Living Memory Recall vs. Recognition
      - Medication Instructions Immediate Recall
      - Medication Instructions Delayed Recall
      - Medication Instructions Delayed Recognition
      - Name/Address/Phone Immediate Recall
      - Name/Address/Phone Delayed Recall
      - Name/Address/Phone Delayed Recognition
    input: select
    multiple: yes
    choices:
      - Daily Living Memory Immediate Recall
      - Daily Living Memory Delayed Recall
      - Daily Living Memory Retention
      - Daily Living Memory Delayed Recognition
      - Daily Living Memory Recall vs. Recognition
      - Medication Instructions Immediate Recall
      - Medication Instructions Delayed Recall
      - Medication Instructions Delayed Recognition
      - Name/Address/Phone Immediate Recall
      - Name/Address/Phone Delayed Recall
      - Name/Address/Phone Delayed Recognition
  table8:
    label: Spatial Module Score Table
    value:
      - Visual Discrimination
      - Design Construction
      - Figure Drawing Copy
      - Figure Drawing Copy Organization
      - Figure Drawing Copy Fragmentation
      - Figure Drawing Copy Planning
      - Figure Drawing Immediate Recall
      - Figure Drawing Immediate Recall Organization
      - Figure Drawing Immediate Recall Fragmentation
      - Figure Drawing Immediate Recall Planning
      - Figure Drawing Percent Retention
      - Map Reading
    input: select
    multiple: yes
    choices:
      - Visual Discrimination
      - Design Construction
      - Figure Drawing Copy
      - Figure Drawing Copy Organization
      - Figure Drawing Copy Fragmentation
      - Figure Drawing Copy Planning
      - Figure Drawing Immediate Recall
      - Figure Drawing Immediate Recall Organization
      - Figure Drawing Immediate Recall Fragmentation
      - Figure Drawing Immediate Recall Planning
      - Figure Drawing Percent Retention
      - Map Reading
  table9:
    label: Executive Functions Module Score Table
    value:
      - Mazes
      - Judgment
      - Categories
      - Word Generation
      - Word Generation Perseverations
    input: select
    multiple: yes
    choices:
      - Mazes
      - Judgment
      - Categories
      - Word Generation
      - Word Generation Perseverations
  column_names1:
    label: Table 1 Column Names
    value:
      - scale
      - score
      - percentile
      - ci_95
      - category
    input: select
    multiple: yes
    choices:
      - scale
      - score
      - percentile
      - ci_95
      - category
  column_names2:
    label: Tables 2-4
    value:
      - scale
      - raw_score
      - z_score
      - score
      - percentile
      - base_rate
      - category
    input: select
    multiple: yes
    choices:
      - scale
      - raw_score
      - z_score
      - score
      - percentile
      - base_rate
      - category
  column_names3:
    label: Tables 5-9
    value:
      - scale
      - raw_score
      - z_score
      - score
      - percentile
      - category
    input: select
    multiple: yes
    choices:
      - scale
      - raw_score
      - z_score
      - score
      - percentile
      - category
  keep1:
    label: Variables to Keep, Set 1
    value:
      - scale
      - raw_score
      - score
      - percentile
      - ci_95
    input: select
    multiple: yes
    choices:
      - scale
      - raw_score
      - score
      - percentile
      - ci_95
  keep2:
    label: Variables to Keep, Set 2
    value:
      - scale
      - raw_score
      - score
      - percentile
    input: select
    multiple: yes
    choices:
      - scale
      - raw_score
      - score
      - percentile
  domain:
    label: NAB Domains
    value: true
    input: select
    multiple: yes
    choices:
      - attention
      - language
      - memory
      - spatial
      - executive
      - index
  slice: true
  eval_index:
    label: Total NAB Index
    value: true
  eval_att:
    label: Attention
    value: true
  eval_lan:
    label: Language
    value: true
  eval_mem1:
    label: "Memory: list learning "
    value: true
  eval_mem2:
    label: "Memory: shape learning"
    value: true
  eval_mem3:
    label: "Memory: story learning"
    value: true
  eval_mem4:
    label: "Memory: daily living"
    value: true
  eval_spt:
    label: Spatial
    value: true
  eval_exe:
    label: Executive
    value: true
  match:
    label: Subset/Match Rows
    input: checkbox
    value: true
output:
  rmdformats::robobook:
    highlight: kate
---

```{r setup, include = FALSE}
Sys.setenv(
  JAVA_HOME = "/Library/Java/JavaVirtualMachines/graalvm-community-openjdk-22.0.1+8.1/Contents/Home"
)
knitr::opts_chunk$set(
  root.dir = normalizePath("./"),
  echo = FALSE,
  message = TRUE,
  warning = TRUE,
  error = TRUE,
  include = FALSE
)
library(dplyr)
library(fs)
library(glue)
library(hablar)
library(here)
library(knitr)
library(magrittr)
library(miniUI)
library(pdftools)
library(rJava)
library(rmarkdown)
library(rmdformats)
library(shiny)
library(snakecase)
library(tabulapdf)
library(tidyverse)
library(xfun)
library(yaml)
library(bwu)
```

## Parameters

```{r}
# source("pluck_nab_params.R")

patient <- params$patient
test <- params$test
test_name <- params$test_name
pages <- params$pages
# file <- file.path(file.choose())
# file <- file.path(params$file)
# saveRDS(file, "nab.rds")
file <- readRDS("nab.rds")
```

## Areas

```{r}
areas <- list(
  index = c(
    top = 133.92299687825,
    left = 64.526534859521,
    bottom = 249.30280957336,
    right = 539.23204994797
  ),
  att = c(
    top = 138.04370447451,
    left = 66.174817898023,
    bottom = 601.21123829344,
    right = 540.88033298647
  ),
  lan = c(
    top = 137.21956295526,
    left = 66.174817898023,
    bottom = 691.86680541103,
    right = 541.70447450572
  ),
  mem1 = c(
    top = 171.83350676379,
    left = 64.526534859521,
    bottom = 570.71800208117,
    right = 540.88033298647
  ),
  mem2 = c(
    top = 118.26430801249,
    left = 66.998959417274,
    bottom = 361.38605619147,
    right = 540.05619146722
  ),
  mem3 = c(
    top = 424.84495317378,
    left = 67.823100936524,
    bottom = 656.42872008325,
    right = 540.88033298647
  ),
  mem4 = c(
    top = 117.44016649324,
    left = 66.174817898023,
    bottom = 400.12070759625,
    right = 540.88033298647
  ),
  spt = c(
    top = 138.86784599376,
    left = 67.823100936524,
    bottom = 446.2726326743,
    right = 538.40790842872
  ),
  exe = c(
    top = 138.86784599376,
    left = 66.998959417274,
    bottom = 271.55463059313,
    right = 540.88033298647
  )
)

# Save the areas list to a file
saveRDS(areas, file = "areas_list.rds")

# Load the areas list from a file
areas <- readRDS("areas_list.rds")
```

```{r eval = FALSE}
# file <- file.path(file.choose())
areas <- tabulapdf::locate_areas(
  file = file,
  pages = c(2, 3, 6, 9, 10, 10, 11, 13, 16)
)
```

```{r}
# Saves areas as text files in df or list
# assuming areas is already defined and contains the desired structure

# Convert the list to a data frame
areas_df <- do.call(rbind, lapply(areas, function(x) as.data.frame(t(x))))

# Write the data frame to a text file
write.table(areas_df, file = "areas_nab.txt", sep = "\t", row.names = FALSE, col.names = TRUE, quote = FALSE)

# Save the list structure to a text file
dput(areas, file = "areas_nab.txt")

# Read the list back into R
areas_nab <- dget("areas_nab.txt")
```

## Extract

```{r}
# Extract tables from the PDF file using `tabulapdf`
plucked_tables <- tabulapdf::extract_tables(
  file = file,
  pages = pages,
  area = areas,
  guess = NULL,
  method = "decide",
  output = "matrix"
)

# Save the list of data frames to a file
saveRDS(plucked_tables, file = "plucked_tables.rds")

# Load the list of data frames from the file
plucked_tables <- readRDS("plucked_tables.rds")

# Verify that the list is loaded correctly
str(plucked_tables)
```

## Functions

```{r}
## Define the Conversion and Tidy Functions
library(dplyr)
library(tibble)
library(glue)

# Function to handle percentile conversion
convert_percentile <- function(df, column_name) {
  df <- df %>%
    mutate(original_percentile = .data[[column_name]]) %>% # Store original percentile values
    mutate(temp_column = as.numeric(ifelse(grepl("^>", .data[[column_name]]),
      as.numeric(sub("^>", "", .data[[column_name]])) + 0.1,
      ifelse(grepl("^<", .data[[column_name]]),
        0.99,
        .data[[column_name]]
      )
    ))) %>%
    mutate(!!column_name := temp_column) %>%
    select(-temp_column)
  return(df)
}

# Function to convert specified columns to integer, double, and factor types
convert_columns <- function(df, to_integer, to_double, to_factor) {
  df <- df %>%
    mutate(across(all_of(to_integer), as.integer, .names = "{.col}")) %>%
    mutate(across(all_of(to_double), as.double, .names = "{.col}")) %>%
    mutate(across(all_of(to_factor), as.factor, .names = "{.col}"))
  return(df)
}

# Function to tidy the data frame and maintain column types
tidy_data <- function(df) {
  # Select scale names (every 3rd row starting from the first one)
  scales <- df %>%
    filter(row_number() %% 3 == 1) %>%
    select(scale)

  # Select data rows (every 3rd row starting from the second one)
  data <- df %>%
    filter(row_number() %% 3 == 2) %>%
    select(-scale)

  # Combine the scale names and data
  tidy_df <- bind_cols(scales, data)

  return(tidy_df)
}
```

## NAB Index Scores (Table 1)

```{r}
table_index <- 1
save_path <- "data"

# Extract table1
table <- tibble::as_tibble(plucked_tables[[table_index]])
colnames(table) <- params$column_names1

# Specify the columns to be converted
to_integer <- c("score")
to_double <- c("percentile")
to_factor <- c("category")

# Apply the convert_percentile function to the percentile column
table <- convert_percentile(table, "percentile")

# Use the function to convert the columns
table <- convert_columns(table, to_integer, to_double, to_factor)

if (params$test == "nab") {
  table[1, 1] <- c("Attention Index (ATT)")
  table[2, 1] <- c("Language Index (LAN)")
  table[3, 1] <- c("Memory Index (MEM)")
  table[4, 1] <- c("Spatial Index (SPT)")
  table[5, 1] <- c("Executive Functions Index (EXE)")
  table[6, 1] <- c("Total NAB Index (T-NAB)")
} else if (params$test == "nabs") {
  table[1, 1] <- c("NAB Total Index")
  table[2, 1] <- c("NAB Language Index")
  table[3, 1] <- c("NAB Memory Index")
  table[4, 1] <- c("NAB Spatial Index")
  table[5, 1] <- c("NAB Executive Functions Index")
  table[6, 1] <- c("NAB Total NAB Index")
} else if (params$test == "nab_main") {
  table[1, 1] <- c("Attention Index (ATT)")
  table[2, 1] <- c("Language Index (LAN)")
  table[3, 1] <- c("Memory Index (MEM)")
  table[4, 1] <- c("Spatial Index (SPT)")
  table[5, 1] <- c("Executive Functions Index (EXE)")
  table[6, 1] <- c("Total NAB Index (T-NAB)")
}

# Save table as csv file
write.csv(table, glue("{save_path}/{test}_table{table_index}.csv"), row.names = FALSE)

# make table 1
table1 <- table
```

## NAB Attention (Table 2)

```{r}
# Extract table
table_index <- 2

table <- tibble::as_tibble(plucked_tables[[table_index]])
colnames(table) <- params$column_names2

# Specify the columns to be converted
to_integer <- c("raw_score", "score")
to_double <- c("percentile", "z_score", "base_rate")
to_factor <- c("category")

# Apply the convert_percentile function to the percentile column
table <- convert_percentile(table, "percentile")

# Use the function to convert the columns
table <- convert_columns(table, to_integer, to_double, to_factor)

# Tidy the data frame
tidy_table <- tidy_data(table)

# Convert columns again after tidying to ensure types are preserved
table <- convert_columns(tidy_table, to_integer, to_double, to_factor)

# Assign to the original table variable
table <- tidy_table

if (params$test == "nabs") {
  table[1, 1] <- c("Orientation")
  table[2, 1] <- c("Orientation to Self")
  table[3, 1] <- c("Orientation to Time")
  table[4, 1] <- c("Orientation to Place")
  table[5, 1] <- c("Orientation to Situation")
  table[6, 1] <- c("Digits Forward")
  table[7, 1] <- c("Digits Forward Longest Span")
  table[8, 1] <- c("Digits Backward")
  table[9, 1] <- c("Digits Backward Longest Span")
  table[10, 1] <- c("Numbers & Letters Part A Speed")
  table[11, 1] <- c("Numbers & Letters Part A Errors")
  table[12, 1] <- c("Numbers & Letters Part A Efficiency")
  table[13, 1] <- c("Numbers & Letters Part B Efficiency")
} else if (params$test == "nab_main") {
  table[1, 1] <- c("Digits Forward")
  table[2, 1] <- c("Digits Backward")
  table[3, 1] <- c("Dots")
  table[4, 1] <- c("Numbers & Letters Part A Efficiency")
  table[5, 1] <- c("Numbers & Letters Part B Efficiency")
  table[6, 1] <- c("Numbers & Letters Part C Efficiency")
  table[7, 1] <- c("Numbers & Letters Part D Efficiency")
  table[8, 1] <- c("Driving Scenes")
} else if (params$test == "nab") {
  table[1, 1] <- c("Orientation")
  table[2, 1] <- c("Orientation to Self")
  table[3, 1] <- c("Orientation to Time")
  table[4, 1] <- c("Orientation to Place")
  table[5, 1] <- c("Orientation to Situation")
  table[6, 1] <- c("Digits Forward")
  table[7, 1] <- c("Digits Forward Longest Span")
  table[8, 1] <- c("Digits Backward")
  table[9, 1] <- c("Digits Backward Longest Span")
  table[10, 1] <- c("Dots")
  table[11, 1] <- c("Numbers & Letters Part A Speed")
  table[12, 1] <- c("Numbers & Letters Part A Errors")
  table[13, 1] <- c("Numbers & Letters Part A Efficiency")
  table[14, 1] <- c("Numbers & Letters Part B Efficiency")
  table[15, 1] <- c("Numbers & Letters Part C Efficiency")
  table[16, 1] <- c("Numbers & Letters Part D Efficiency")
  table[17, 1] <- c("Numbers & Letters Part D Disruption")
  table[18, 1] <- c("Driving Scenes")
}

# Save table as csv file
write.csv(table, glue("{save_path}/{test}_table{table_index}.csv"), row.names = FALSE)

# make table 2
table2 <- table
```

## NAB Language (Table 3)

```{r}
# extract table
table_index <- 3

# Assuming is already defined
table <- as_tibble(plucked_tables[[table_index]])
colnames(table) <- params$column_names2

# Specify the columns to be converted
to_integer <- c("raw_score", "score", "percentile")
to_double <- c("z_score", "base_rate")
to_factor <- c("category")

# Use the function to convert the columns
table <- convert_columns(table, to_integer, to_double, to_factor)

# Use the function to tidy the data frame
tidy_table <- tidy_data(table)

# View the resulting tidy data frame
print(tidy_table)

# scales
table <- tidy_table

if (params$test == "nabs") {
  table[1, 1] <- c("Auditory Comprehension")
  table[2, 1] <- c("Auditory Comprehension Colors")
  table[3, 1] <- c("Auditory Comprehension Shapes")
  table[4, 1] <- c("Auditory Comprehension Colors/Shapes/Numbers")
  table[5, 1] <- c("Naming")
  table[6, 1] <- c("Naming Semantic Cuing")
  table[7, 1] <- c("Naming Phonemic Cuing")
} else if (params$test == "nab_main") {
  table[1, 1] <- c("Oral Production")
  table[2, 1] <- c("Auditory Comprehension")
  table[3, 1] <- c("Naming")
  table[4, 1] <- c("Writing")
  table[5, 1] <- c("Bill Payment")
} else if (params$test == "nab") {
  table[1, 1] <- c("Oral Production")
  table[2, 1] <- c("Auditory Comprehension")
  table[3, 1] <- c("Auditory Comprehension Colors")
  table[4, 1] <- c("Auditory Comprehension Shapes")
  table[5, 1] <- c("Auditory Comprehension Colors/Shapes/Numbers")
  table[6, 1] <- c("Auditory Comprehension Pointing")
  table[7, 1] <- c("Auditory Comprehension Yes/No")
  table[8, 1] <- c("Auditory Comprehension Paper Folding")
  table[9, 1] <- c("Naming")
  table[10, 1] <- c("Naming Semantic Cuing")
  table[11, 1] <- c("Naming Phonemic Cuing")
  table[12, 1] <- c("Reading Comprehension")
  table[13, 1] <- c("Reading Comprehension Words")
  table[14, 1] <- c("Reading Comprehension Sentences")
  table[15, 1] <- c("Writing")
  table[16, 1] <- c("Writing Legibility")
  table[17, 1] <- c("Writing Spelling")
  table[18, 1] <- c("Writing Syntax")
  table[19, 1] <- c("Writing Conveyance")
  table[20, 1] <- c("Bill Payment")
}

# Save table as csv file
write.csv(table, glue("{save_path}/{test}_table{table_index}.csv"), row.names = FALSE)

# make table 3
table3 <- table
print(table3)
```

## NAB List Learning (Table 4)

```{r}
# extract table
table_index <- 4

# Assuming is already defined
table <- as_tibble(plucked_tables[[table_index]])
colnames(table) <- params$column_names2

# Specify the columns to be converted
to_integer <- c("raw_score", "score", "percentile")
to_double <- c("z_score", "base_rate")
to_factor <- c("category")

# Use the function to convert the columns
table <- convert_columns(table, to_integer, to_double, to_factor)

# Use the function to tidy the data frame
tidy_table <- tidy_data(table)

# View the resulting tidy data frame
print(tidy_table)

# scales
table <- tidy_table

if (params$test == "nab") {
  table[1, 1] <- c("List Learning List A Trial 1 Immediate Recall")
  table[2, 1] <- c("List Learning List A Trial 2 Immediate Recall")
  table[3, 1] <- c("List Learning List A Trial 3 Immediate Recall")
  table[4, 1] <- c("List Learning List A Immediate Recall")
  table[5, 1] <- c("List Learning List B Immediate Recall")
  table[6, 1] <- c("List Learning List A Short Delayed Recall")
  table[7, 1] <- c("List Learning List A Long Delayed Recall")
  table[8, 1] <- c("List Learning List A Percent Retention")
  table[9, 1] <- c("List Learning List A Long Delayed Forced-Choice Recognition")
  table[10, 1] <- c("List Learning List A Long Delayed Forced-Choice Recognition False Alarms")
  table[11, 1] <- c("List Learning List A Discriminability Index")
  table[12, 1] <- c("List Learning List A Recall vs. Recognition Index")
  table[13, 1] <- c("List Learning Semantic Clusters")
  table[14, 1] <- c("List Learning Perseverations")
  table[15, 1] <- c("List Learning Intrusions")
} else if (params$test == "nab_main") {
  table[1, 1] <- c("List Learning List A Immediate Recall")
  table[2, 1] <- c("List Learning List A Short Delayed Recall")
  table[3, 1] <- c("List Learning List A Long Delayed Recall")
} else if (params$test == "nabs") {
  table[1, 1] <- c("Shape Learning Immediate Recognition")
  table[2, 1] <- c("Shape Learning Delayed Recognition")
  table[3, 1] <- c("Shape Learning Percent Retention")
  table[4, 1] <- c("Story Learning Immediate Recall")
  table[5, 1] <- c("Story Learning Delayed Recall")
  table[6, 1] <- c("Story Learning Percent Retention")
}

# Save table as csv file
write.csv(table, glue("{save_path}/{test}_table{table_index}.csv"), row.names = FALSE)

# make table 4
table4 <- table
print(table4)
```

## NAB Shape Learning (Table 5)

```{r}
# extract table
table_index <- 5

# Assuming is already defined
table <- as_tibble(plucked_tables[[table_index]])
colnames(table) <- params$column_names3

# Specify the columns to be converted
to_integer <- c("raw_score", "score", "percentile")
to_double <- c("z_score")
to_factor <- c("category")

# Use the function to convert the columns
table <- convert_columns(table, to_integer, to_double, to_factor)

# Use the function to tidy the data frame
tidy_table <- tidy_data(table)

# View the resulting tidy data frame
print(tidy_table)

# scales
table <- tidy_table

if (params$test == "nabs") {
  table[1, 1] <- c("Visual Discrimination")
  table[2, 1] <- c("Design Construction")
} else if (params$test == "nab_main") {
  table[4, 1] <- c("Shape Learning Immediate Recognition")
  table[5, 1] <- c("Shape Learning Delayed Recognition")
} else if (params$test == "nab") {
  table[1, 1] <- c("Shape Learning Trial 1 Immediate Recognition")
  table[2, 1] <- c("Shape Learning Trial 2 Immediate Recognition")
  table[3, 1] <- c("Shape Learning Trial 3 Immediate Recognition")
  table[4, 1] <- c("Shape Learning Immediate Recognition")
  table[5, 1] <- c("Shape Learning Delayed Recognition")
  table[6, 1] <- c("Shape Learning Percent Retention")
  table[7, 1] <- c("Shape Learning Delayed Forced-Choice Recognition")
  table[8, 1] <- c("Shape Learning Delayed Forced-Choice Recognition False Alarms")
  table[9, 1] <- c("Shape Learning Discriminability Index")
}

# Save table as csv file
write.csv(table, glue("{save_path}/{test}_table{table_index}.csv"), row.names = FALSE)

# make table 5
table5 <- table
print(table5)
```

## NAB Story Learning (Table 6)

```{r}
# extract table
table_index <- 6

# Assuming is already defined
table <- as_tibble(plucked_tables[[table_index]])
colnames(table) <- params$column_names3

# Specify the columns to be converted
to_integer <- c("raw_score", "score", "percentile")
to_double <- c("z_score")
to_factor <- c("category")

# Use the function to convert the columns
table <- convert_columns(table, to_integer, to_double, to_factor)

# Use the function to tidy the data frame
tidy_table <- tidy_data(table)

# View the resulting tidy data frame
print(tidy_table)

# scales
table <- tidy_table

if (params$test == "nab") {
  table[1, 1] <- c("Story Learning Trial 1 Phrase Unit")
  table[2, 1] <- c("Story Learning Trial 2 Phrase Unit")
  table[3, 1] <- c("Story Learning Phrase Unit Immediate Recall")
  table[4, 1] <- c("Story Learning Thematic Unit Immediate Recall")
  table[5, 1] <- c("Story Learning Trial 1 Thematic Unit")
  table[6, 1] <- c("Story Learning Trial 2 Thematic Unit")
  table[7, 1] <- c("Story Learning Phrase Unit Delayed Recall")
  table[8, 1] <- c("Story Learning Thematic Unit Delayed Recall")
  table[9, 1] <- c("Story Learning Phrase Unit Percent Retention")
} else if (params$test == "nab_main") {
  table[1, 1] <- c("Story Learning Phrase Unit Immediate Recall")
  table[2, 1] <- c("Story Learning Phrase Unit Long Delayed Recall")
} else if (params$test == "nabs") {
  table[1, 1] <- c("Mazes")
  table[2, 1] <- c("Word Generation")
  table[3, 1] <- c("Word Generation Perseverations")
}

# Save table as csv file
write.csv(table, glue("{save_path}/{test}_table{table_index}.csv"), row.names = FALSE)

# make table 6
table6 <- table
print(table6)
```

## NAB Daily Living Memory (Table 7)

```{r}
# extract table
table_index <- 7

# Assuming is already defined
table <- as_tibble(plucked_tables[[table_index]])
colnames(table) <- params$column_names3

# Specify the columns to be converted
to_integer <- c("raw_score", "score", "percentile")
to_double <- c("z_score")
to_factor <- c("category")

# Use the function to convert the columns
table <- convert_columns(table, to_integer, to_double, to_factor)

# Use the function to tidy the data frame
tidy_table <- tidy_data(table)

# View the resulting tidy data frame
print(tidy_table)

# scales
table <- tidy_table

if (params$test == "nab") {
  table[1, 1] <- c("Daily Living Memory Immediate Recall")
  table[2, 1] <- c("Daily Living Memory Delayed Recall")
  table[3, 1] <- c("Daily Living Memory Retention")
  table[4, 1] <- c("Daily Living Memory Delayed Recognition")
  table[5, 1] <- c("Daily Living Memory Recall vs. Recognition")
  table[6, 1] <- c("Medication Instructions Immediate Recall")
  table[7, 1] <- c("Medication Instructions Delayed Recall")
  table[8, 1] <- c("Medication Instructions Delayed Recognition")
  table[9, 1] <- c("Name/Address/Phone Immediate Recall")
  table[10, 1] <- c("Name/Address/Phone Delayed Recall")
  table[11, 1] <- c("Name/Address/Phone Delayed Recognition")
} else if (params$test == "nab_main") {
  table[1, 1] <- c("Daily Living Memory Immediate Recall")
  table[2, 1] <- c("Daily Living Memory Delayed Recall")
}

# Save table as csv file
write.csv(table, glue("{save_path}/{test}_table{table_index}.csv"), row.names = FALSE)

# make table 7
table7 <- table
```

## NAB Spatial Module (Table 8)

```{r}
# extract table
table_index <- 8

# Assuming is already defined
table <- as_tibble(plucked_tables[[table_index]])
colnames(table) <- params$column_names3

# Specify the columns to be converted
to_integer <- c("raw_score", "score", "percentile")
to_double <- c("z_score")
to_factor <- c("category")

# Use the function to convert the columns
table <- convert_columns(table, to_integer, to_double, to_factor)

# Use the function to tidy the data frame
tidy_table <- tidy_data(table)

# View the resulting tidy data frame
print(tidy_table)

# scales
table <- tidy_table

if (params$test == "nab") {
  table[1, 1] <- c("Visual Discrimination")
  table[2, 1] <- c("Design Construction")
  table[3, 1] <- c("Figure Drawing Copy")
  table[4, 1] <- c("Figure Drawing Copy Organization")
  table[5, 1] <- c("Figure Drawing Copy Fragmentation")
  table[6, 1] <- c("Figure Drawing Copy Planning")
  table[7, 1] <- c("Figure Drawing Immediate Recall")
  table[8, 1] <- c("Figure Drawing Immediate Recall Organization")
  table[9, 1] <- c("Figure Drawing Immediate Recall Fragmentation")
  table[10, 1] <- c("Figure Drawing Immediate Recall Planning")
  table[11, 1] <- c("Figure Drawing Percent Retention")
  table[12, 1] <- c("Map Reading")
} else if (params$test == "nab_main") {
  table[1, 1] <- c("Visual Discrimination")
  table[2, 1] <- c("Design Construction")
  table[3, 1] <- c("Figure Drawing Copy")
  table[4, 1] <- c("Map Reading")
}

# Save table as csv file
write.csv(table, glue("{save_path}/{test}_table{table_index}.csv"), row.names = FALSE)

# make table 8
table8 <- table
```

## NAB Executive Functions Module (Table 9)

```{r}
# extract table
table_index <- 9

table <- as_tibble(plucked_tables[[table_index]])
colnames(table) <- params$column_names3

# Specify the columns to be converted
to_integer <- c("raw_score", "score", "percentile")
to_double <- c("z_score")
to_factor <- c("category")

# Use the function to convert the columns
table <- convert_columns(table, to_integer, to_double, to_factor)

# Use the function to tidy the data frame
tidy_table <- tidy_data(table)

# View the resulting tidy data frame
print(tidy_table)

# scales
table <- tidy_table

if (params$test == "nab") {
  table[1, 1] <- c("Mazes")
  table[2, 1] <- c("Judgment")
  table[3, 1] <- c("Categories")
  table[4, 1] <- c("Word Generation")
  table[5, 1] <- c("Word Generation Perseverations")
} else if (params$test == "nab_main") {
  table[1, 1] <- c("Mazes")
  table[2, 1] <- c("Judgment")
  table[3, 1] <- c("Categories")
  table[4, 1] <- c("Word Generation")
} 

# Save table as csv file
write.csv(table, glue("{save_path}/{test}_table{table_index}.csv"), row.names = FALSE)

# make table 9
table9 <- table
```

## Mutate

```{r}
table1 <- bwu::gpluck_make_columns(
  table1,
  test = params$test,
  test_name = params$test_name,
  raw_score = "",
  z_score = "",
  range = "",
  base_rate = "",
  domain = "",
  subdomain = "",
  narrow = "",
  pass = "",
  verbal = "",
  timed = "",
  score_type = "standard_score",
  test_type = "npsych_test",
  description = "",
  result = ""
)

table2 <- bwu::gpluck_make_columns(
  table2,
  test = params$test,
  test_name = params$test_name,
  ci_95 = "",
  range = "",
  domain = "Attention/Executive",
  subdomain = "",
  narrow = "",
  pass = "",
  verbal = "",
  timed = "",
  score_type = "t_score",
  test_type = "npsych_test",
  description = "",
  result = ""
)

table3 <- bwu::gpluck_make_columns(
  table3,
  test = params$test,
  test_name = params$test_name,
  ci_95 = "",
  range = "",
  domain = "Verbal/Language",
  subdomain = "",
  narrow = "",
  pass = "Sequential",
  verbal = "Verbal",
  timed = "Untimed",
  score_type = "t_score",
  test_type = "npsych_test",
  description = "",
  result = ""
)

table4 <- bwu::gpluck_make_columns(
  table4,
  test = params$test,
  test_name = params$test_name,
  ci_95 = "",
  range = "",
  domain = "Memory",
  subdomain = "",
  narrow = "",
  pass = "Sequential",
  verbal = "Verbal",
  timed = "Untimed",
  score_type = "t_score",
  test_type = "npsych_test",
  description = "",
  result = ""
)

table5 <- bwu::gpluck_make_columns(
  table5,
  test = params$test,
  test_name = params$test_name,
  ci_95 = "",
  range = "",
  domain = "Memory",
  subdomain = "",
  narrow = "",
  pass = "Simultaneous",
  verbal = "Nonverbal",
  timed = "Untimed",
  score_type = "t_score",
  test_type = "npsych_test",
  description = "",
  result = ""
)

table6 <- bwu::gpluck_make_columns(
  table6,
  test = params$test,
  test_name = params$test_name,
  ci_95 = "",
  range = "",
  domain = "Memory",
  subdomain = "",
  narrow = "",
  pass = "Sequential",
  verbal = "Verbal",
  timed = "Untimed",
  score_type = "t_score",
  test_type = "npsych_test",
  description = "",
  result = ""
)

table7 <- bwu::gpluck_make_columns(
  table7,
  test = params$test,
  test_name = params$test_name,
  ci_95 = "",
  range = "",
  domain = "Memory",
  subdomain = "",
  narrow = "",
  pass = "Sequential",
  verbal = "Verbal",
  timed = "Untimed",
  score_type = "t_score",
  test_type = "npsych_test",
  description = "",
  result = ""
)

table8 <- bwu::gpluck_make_columns(
  table8,
  test = params$test,
  test_name = params$test_name,
  ci_95 = "",
  range = "",
  domain = "Visual Perception/Construction",
  subdomain = "",
  narrow = "",
  pass = "Simultaneous",
  verbal = "Nonverbal",
  timed = "",
  score_type = "t_score",
  test_type = "npsych_test",
  description = "",
  result = ""
)

table9 <- bwu::gpluck_make_columns(
  table9,
  test = params$test,
  test_name = params$test_name,
  ci_95 = "",
  range = "",
  domain = "Attention/Executive",
  subdomain = "",
  narrow = "",
  pass = "",
  verbal = "",
  timed = "Untimed",
  score_type = "t_score",
  test_type = "npsych_test",
  description = "",
  result = ""
)
```

## Range

```{r}
# Create a list of your tables
tables <- list(table1, table2, table3, table4, table5, table6, table7, table8, table9)

# Apply the function to each table using a for loop
for (i in seq_along(tables)) {
  tables[[i]] <- bwu::gpluck_make_score_ranges(table = tables[[i]], test_type = "npsych_test")
}

# Optionally, assign the modified tables back to individual variables if needed
table1 <- tables[[1]]
table2 <- tables[[2]]
table3 <- tables[[3]]
table4 <- tables[[4]]
table5 <- tables[[5]]
table6 <- tables[[6]]
table7 <- tables[[7]]
table8 <- tables[[8]]
table9 <- tables[[9]]
```

## Domains

```{r}
table1 <-
  table1 |>
  dplyr::mutate(
    domain = dplyr::case_when(
      scale == "Attention Index (ATT)" ~ "Attention/Executive",
      scale == "Language Index (LAN)" ~ "Verbal/Language",
      scale == "Memory Index (MEM)" ~ "Memory",
      scale == "Spatial Index (SPT)" ~ "Visual Perception/Construction",
      scale == "Executive Functions Index (EXE)" ~ "Attention/Executive",
      scale == "Total NAB Index (T-NAB)" ~ "General Cognitive Ability",
      TRUE ~ as.character(domain)
    )
  )
```

## Subdomains

```{r}
# Table 1
table1 <-
  table1 |>
  dplyr::mutate(
    subdomain = dplyr::case_when(
      scale == "Attention Index (ATT)" ~ "Attention",
      scale == "Language Index (LAN)" ~ "Language",
      scale == "Memory Index (MEM)" ~ "Memory",
      scale == "Spatial Index (SPT)" ~ "Spatial",
      scale == "Executive Functions Index (EXE)" ~ "Executive",
      scale == "Total NAB Index (T-NAB)" ~ "Neuropsychological Functioning",
      TRUE ~ as.character(subdomain)
    )
  )

# Table 2
orientation <- c(
  "Orientation",
  "Orientation to Self",
  "Orientation to Time",
  "Orientation to Place",
  "Orientation to Situation"
)
dsf <- c(
  "Digits Forward",
  "Digits Forward Longest Span"
)
dsb <- c(
  "Digits Backward",
  "Digits Backward Longest Span"
)
nlt <- c(
  "Numbers & Letters Part A Speed",
  "Numbers & Letters Part A Efficiency",
  "Numbers & Letters Part B Efficiency",
  "Numbers & Letters Part C Efficiency",
  "Numbers & Letters Part D Efficiency"
)
nle <- c(
  "Numbers & Letters Part A Errors"
)

table2 <-
  table2 |>
  dplyr::mutate(
    subdomain = dplyr::case_when(
      scale %in% orientation ~ "Attention",
      scale %in% dsf ~ "Attention",
      scale %in% dsb ~ "Working Memory",
      scale == "Numbers & Letters Part A Speed" ~ "Processing Speed",
      scale == "Numbers & Letters Part A Errors" ~ "Attention",
      scale == "Numbers & Letters Part A Efficiency" ~ "Processing Speed",
      scale == "Numbers & Letters Part B Efficiency" ~ "Attention",
      scale == "Numbers & Letters Part C Efficiency" ~ "Attention",
      scale == "Numbers & Letters Part D Efficiency" ~ "Attention",
      scale == "Numbers & Letters Part D Disruption" ~ "Attention",
      scale == "Dots" ~ "Working Memory",
      scale == "Driving Scenes" ~ "Attention",
      TRUE ~ as.character(subdomain)
    )
  )

# Table 3  
table3 <-
  table3 |>
  dplyr::mutate(
    subdomain = dplyr::case_when(
      scale %in% c("Auditory Comprehension") ~ "Listening Ability",
      scale %in% c("Naming") ~ "Retrieval",
      scale %in% c("Oral Production") ~ "Expression",
      scale %in% c("Reading Comprehension") ~ "Comprehension",
      scale %in% c("Writing") ~ "Expression",
      scale %in% c("Bill Payment") ~ "Daily Living",
      TRUE ~ as.character(subdomain)
    )
  )

# Table 4
table4 <-
  table4 |>
  dplyr::mutate(
    subdomain = dplyr::case_when(
      scale %in% c("Trial") ~ "Learning Trials",
      scale %in% c("Immediate") ~ "Learning Efficiency",
      scale %in% c("Short Delayed", "Long Delayed") ~ "Delayed Recall",
      scale %in% c("Recognition", "Discriminability") ~ "Delayed Recall",
      scale %in% c("Semantic Clusters") ~ "Learning Efficiency",
      scale %in% c("Perseverations", "Intrusions") ~ "Attention",
      TRUE ~ as.character(subdomain)
    )
  )

# Table 5
table5 <-
  table5 |>
  dplyr::mutate(
    subdomain = dplyr::case_when(
      scale %in% c("Trial") ~ "Learning Trials",
      scale %in% c("Immediate") ~ "Learning Efficiency",
      scale %in% c("Delayed") ~ "Delayed Recall",
      scale %in% c("Recognition", "Discriminability") ~ "Delayed Recall",
      TRUE ~ as.character(subdomain)
    )
  )

# Table 6
table6 <-
  table6 |>
  dplyr::mutate(
    subdomain = dplyr::case_when(
      scale %in% c("Trial") ~ "Learning Trials",
      scale %in% c("Immediate") ~ "Learning Efficiency",
      scale %in% c("Delayed") ~ "Delayed Recall",
      scale %in% c("Recognition", "Discriminability") ~ "Delayed Recall",
      TRUE ~ as.character(subdomain)
    )
  )

# Table 7
table7 <-
  table7 |>
  dplyr::mutate(
    subdomain = dplyr::case_when(
      scale %in% c("Immediate") ~ "Learning Efficiency",
      scale %in% c("Delayed") ~ "Delayed Recall",
      scale %in% c("Recognition", "Discriminability") ~ "Delayed Recall",
      TRUE ~ as.character(subdomain)
    )
  )

# Table 8
table8 <-
  table8 |>
  dplyr::mutate(
    subdomain = dplyr::case_when(
      scale == "Visual Discrimination" ~ "Perception",
      scale == "Design Construction" ~ "Construction",
      scale %in% c("Copy") ~ "Organization",
      scale %in% c("Recall", "Retention") ~ "Delayed Recall",
      scale == "Map Reading" ~ "Awareness",
      TRUE ~ as.character(subdomain)
    )
  )

# Table 9
table9 <-
  table9 |>
  dplyr::mutate(
    subdomain = dplyr::case_when(
      scale == "Mazes" ~ "Executive Functioning",
      scale == "Word Generation" ~ "Executive Functioning",
      scale == "Word Generation Perseverations" ~ "Attention",
      scale == "Categories" ~ "Executive Functioning",
      scale == "Judgment" ~ "Executive Functioning",
      TRUE ~ as.character(subdomain)
    )
  )
```

## Narrow

```{r}
table1 <-
  table1 |>
  dplyr::mutate(
    narrow = dplyr::case_when(
      scale == "Attention Index (ATT)" ~ "Attention Index",
      scale == "Language Index (LAN)" ~ "Language Index",
      scale == "Memory Index (MEM)" ~ "Memory Index",
      scale == "Spatial Index (SPT)" ~ "Spatial Index",
      scale == "Executive Functions Index (EXE)" ~ "Executive Functions Index",
      scale == "Total NAB Index (T-NAB)" ~ "Neurocognitive Index",
      TRUE ~ as.character(narrow)
    )
  )

table2 <-
  table2 |>
  dplyr::mutate(
    narrow = dplyr::case_when(
      scale %in% orientation ~ "Orientation",
      scale %in% dsf ~ "Attention Span",
      scale %in% dsb ~ "Verbal Working Memory",
      scale == "Numbers & Letters Part A Speed" ~ "Psychomotor Speed",
      scale == "Numbers & Letters Part A Errors" ~ "Response Monitoring",
      scale == "Numbers & Letters Part A Efficiency" ~ "Cognitive Efficiency",
      scale == "Numbers & Letters Part B Efficiency" ~ "Attentional Fluency",
      scale == "Numbers & Letters Part C Efficiency" ~ "Attentional Fluency",
      scale == "Numbers & Letters Part D Efficiency" ~ "Attentional Fluency",
      scale == "Dots" ~ "Nonverbal Working Memory",
      scale == "Driving Scenes" ~ "Attentional Capacity",
      TRUE ~ as.character(narrow)
    )
  )

table3 <-
  table3 |>
  dplyr::mutate(
    narrow = dplyr::case_when(
      scale %in% c("Auditory Comprehension") ~ "Auditory Comprehension",
      scale %in% c("Naming") ~ "Naming",
      scale %in% c("Oral Production") ~ "Expression",
      scale %in% c("Reading Comprehension") ~ "Comprehension",
      scale %in% c("Writing") ~ "Expression",
      scale %in% c("Bill Payment") ~ "Daily Living",
      TRUE ~ as.character(narrow)
    )
  )

table4 <-
  table4 |>
  dplyr::mutate(
    narrow = dplyr::case_when(
      scale %in% c("List Learning Immediate") ~ "Word-List Learning",
      scale %in% c("List Learning Delayed") ~ "Free-Recall Memory",
      TRUE ~ as.character(narrow)
    )
  )

table5 <-
  table5 |>
  dplyr::mutate(
    narrow = dplyr::case_when(
      scale %in% c("Shape") ~ "Visual Memory",
      scale %in% c("Recognition") ~ "Visual Memory",
      TRUE ~ as.character(narrow)
    )
  )

table6 <-
  table6 |>
  dplyr::mutate(narrow = dplyr::case_when(
    scale %in% c("Story Learning") ~ "Story Memory",
    TRUE ~ as.character(narrow)
  ))

table7 <-
  table7 |>
  dplyr::mutate(
    narrow = dplyr::case_when(
      scale == c("Daily Living Memory") ~ "Daily Living",
      scale == c("Daily Living Memory Recall") ~ "Daily Living",
      TRUE ~ as.character(narrow)
    )
  )

table8 <-
  table8 |>
  dplyr::mutate(
    narrow = dplyr::case_when(
      scale == "Visual Discrimination" ~ "Perception",
      scale == "Design Construction" ~ "Construction",
      TRUE ~ as.character(narrow)
    )
  )
table9 <-
  table9 |>
  dplyr::mutate(
    narrow = dplyr::case_when(
      scale == "Mazes" ~ "Planning",
      scale == "Word Generation" ~ "Generativity",
      scale == "Word Generation Perseverations" ~ "Response Monitoring",
      scale == "Judgment" ~ "Judgment",
      scale == "Categories" ~ "Concept Formation",
      TRUE ~ as.character(narrow)
    )
  )
```

## PASS

```{r}
table1 <-
  table1 |>
  dplyr::mutate(
    pass = dplyr::case_when(
      scale == "Attention Index (ATT)" ~ "Attention",
      scale == "Language Index (LAN)" ~ "",
      scale == "Memory Index (MEM)" ~ "",
      scale == "Spatial Index (SPT)" ~ "Simultaneous",
      scale == "Executive Functions Index (EXE)" ~ "Planning",
      scale == "Total NAB Index (T-NAB)" ~ "",
      TRUE ~ as.character(pass)
    )
  )

table2 <-
  table2 |>
  dplyr::mutate(
    pass = dplyr::case_when(
      scale %in% orientation ~ "Attention",
      scale %in% dsf ~ "Sequential",
      scale %in% dsb ~ "Attention",
      scale %in% nlt ~ "Attention",
      scale %in% nle ~ "Attention",
      TRUE ~ as.character(pass)
    )
  )

table3 <-
  table3 |>
  dplyr::mutate(
    pass = dplyr::case_when(
      scale %in% c("Auditory Comprehension") ~ "Sequential",
      scale %in% c("Naming") ~ "Knowledge",
      TRUE ~ as.character(pass)
    )
  )

table4 <-
  table4 |>
  dplyr::mutate(
    pass = dplyr::case_when(
      scale %in% c("List Learning") ~ "Sequential",
      TRUE ~ as.character(pass)
    )
  )

table8 <-
  table8 |>
  dplyr::mutate(
    pass = dplyr::case_when(
      scale %in% c("Copy") ~ "Planning",
      scale == c("Recall") ~ "Simultaneous",
      TRUE ~ as.character(pass)
    )
  )

table9 <-
  table9 |>
  dplyr::mutate(
    pass = dplyr::case_when(
      scale == "Mazes" ~ "Planning",
      scale == "Word Generation" ~ "Sequential",
      scale == "Word Generation Perseverations" ~ "Attention",
      TRUE ~ as.character(pass)
    )
  )
```

## Verbal

```{r}
table1 <-
  table1 |>
  dplyr::mutate(
    verbal = dplyr::case_when(
      scale == "Attention Index (ATT)" ~ "",
      scale == "Language Index (LAN)" ~ "Verbal",
      scale == "Memory Index (MEM)" ~ "",
      scale == "Spatial Index (SPT)" ~ "Nonverbal",
      scale == "Executive Functions Index (EXE)" ~ "",
      scale == "Total NAB Index (T-NAB)" ~ "",
      TRUE ~ as.character(verbal)
    )
  )

table2 <-
  table2 |>
  dplyr::mutate(
    verbal = dplyr::case_when(
      scale %in% orientation ~ "Verbal",
      scale %in% dsf ~ "Verbal",
      scale %in% dsb ~ "Verbal",
      scale %in% nlt ~ "Nonverbal",
      scale %in% nle ~ "Nonverbal",
      scale %in% c("Dots") ~ "Nonverbal",
      scale %in% c("Driving") ~ "",
      TRUE ~ as.character(verbal)
    )
  )

table9 <-
  table9 |>
  dplyr::mutate(
    verbal = dplyr::case_when(
      scale == "Mazes" ~ "Nonverbal",
      scale %in% c("Word Generation") ~ "Verbal",
      scale %in% c("Judgment") ~ "Verbal",
      scale %in% c("Categories") ~ "",
      TRUE ~ as.character(verbal)
    )
  )

```

## Timed

```{r}
table1 <-
  table1 |>
  dplyr::mutate(
    timed = dplyr::case_when(
      scale == "Attention Index (ATT)" ~ "",
      scale == "Language Index (LAN)" ~ "Untimed",
      scale == "Memory Index (MEM)" ~ "",
      scale == "Spatial Index (SPT)" ~ "",
      scale == "Executive Functions Index (EXE)" ~ "",
      scale == "Total NAB Index (T-NAB)" ~ "",
      TRUE ~ as.character(timed)
    )
  )

table2 <-
  table2 |>
  dplyr::mutate(
    timed = dplyr::case_when(
      scale %in% orientation ~ "Untimed",
      scale %in% dsf ~ "Untimed",
      scale %in% dsb ~ "Untimed",
      scale %in% nlt ~ "Timed",
      scale %in% nle ~ "Timed",
      TRUE ~ as.character(timed)
    )
  )

table9 <-
  table9 |>
  dplyr::mutate(
    timed = dplyr::case_when(
      scale == "Mazes" ~ "Timed",
      scale == "Word Generation" ~ "Timed",
      scale == "Word Generation Perseverations" ~ "Timed",
      TRUE ~ as.character(timed)
    )
  )
```

## Score Type

```{r}
table2 <-
  table2 |>
  dplyr::mutate(
    score_type = dplyr::case_when(
      scale == "Orientation" ~ "percentile",
      scale == "Orientation to Self" ~ "base_rate",
      scale == "Orientation to Time" ~ "base_rate",
      scale == "Orientation to Place" ~ "base_rate",
      scale == "Orientation to Situation" ~ "base_rate",
      scale == "Digits Forward Longest Span" ~ "raw_score",
      scale == "Digits Backward Longest Span" ~ "raw_score",
      TRUE ~ as.character(score_type)
    )
  )

table3 <-
  table3 |>
  dplyr::mutate(
    score_type = dplyr::case_when(
      scale == "Auditory Comprehension Colors" ~ "base_rate",
      scale == "Auditory Comprehension Shapes" ~ "base_rate",
      scale == "Auditory Comprehension Colors/Shapes/Numbers" ~ "base_rate",
      scale == "Naming Semantic Cuing" ~ "base_rate",
      scale == "Naming Phonemic Cuing" ~ "base_rate",
      TRUE ~ as.character(score_type)
    )
  )

table5 <-
  table5 |>
  dplyr::mutate(
    score_type = dplyr::case_when(
      scale == "Shape Learning Percent Retention" ~ "percentile",
      scale == "Story Learning Percent Retention" ~ "percentile",
      TRUE ~ as.character(score_type)
    )
  )

table9 <-
  table9 |>
  dplyr::mutate(
    score_type = dplyr::case_when(
      scale == "Word Generation Perseverations" ~ "percentile",
      TRUE ~ as.character(score_type)
    )
  )
```

## Descriptions

```{r}
table1 <-
  table1 |>
  dplyr::mutate(
    description = dplyr::case_when(
      scale ==
        "Attention Index (ATT)" ~ "An overall screening measure of the examinee's attentional functioning",
      
      scale ==
        "Language Index (LAN)" ~ "The patient’s general ability to access and apply acquired word knowledge, to verbalize meaningful concepts, think about verbal information, and express themself using words",
      
      scale ==
        "Memory Index (MEM)" ~ "A composite measure of the examinee's verbal and visual memory functioning",
      
      scale ==
        "Spatial Index (SPT)" ~ "A composite screening measure of visuoperceptual skills, attention to detail, and visuoconstructional skills",
      
      scale ==
        "Executive Functions Index (EXE)" ~ "A composite measure of executive skills involving planning, inhibition, speed/fluency, and generativity",
      
      scale == "Total NAB Index (T-NAB)" ~ "An omnibus measure of neuropsychological
      functioning (independent of general intelligence) in the domains of
      attentional and executive functioning, language processing,
      visuospatial processing, and learning and memory",
      TRUE ~ as.character(description)
    )
  )

table2 <-
  table2 |>
  dplyr::mutate(
    description = dplyr::case_when(
      scale == "Orientation" ~ "Orientation to person, place, time, and situation",
      scale == "Digits Forward" ~ "Auditory attentional capacity, or how much information can be processed at once",
      scale == "Digits Forward Longest Span" ~ "Auditory attentional capacity",
      
      scale == "Digits Backward" ~ "A measure of both attentional capacity and working memory",
      
      scale == "Digits Backward Longest Span" ~ "Working memory for orally presented information",
      
      scale == "Numbers & Letters Part A Speed" ~ "Focused attention and rapid visual scanning",
      
      scale == "Numbers & Letters Part A Errors" ~ "A marker of reduced focus and distractibility",
      
      scale == "Numbers & Letters Part A Efficiency" ~ "Focused attention and
      rapid visual scanning on overall measure of efficiency in performing a
      selective attention letter cancellation task",
      
      scale == "Numbers & Letters Part B Efficiency" ~ "A speeded focused 
      attention letter-counting task requiring the patient to count all of the 
      target X’s in successive rows of random numbers and letters (instead of 
      having to draw marks through each X)", # CHECK
      
      scale == "Numbers & Letters Part C Efficiency" ~ "A speeded serial addition task in which they had to add the numbers in successive rows of random numbers and letters on a page",
      
      scale == "Numbers & Letters Part D Efficiency" ~ "Performance on a complex measure of divided attention, information processing speed, and inhibition",
      
      scale == "Dots" ~ "Performance on a delayed recognition visual span task, in which an array of dots was exposed for a brief period, followed by a blank page, and then a new array with one additional dot that the patient had to point out",
      
      scale == "Driving Scences" ~ "A test of visual scanning, attention to detail, and selective attention in which he viewed a series of six driving scenes (as viewed from behind a steering wheel) and then had to indicate subtle changes of what was new, different, or missing relative to the previously viewed scene",
      TRUE ~ as.character(description)
    )
  )

table3 <-
  table3 |>
  dplyr::mutate(
    description = dplyr::case_when(
      scale == "Oral Expression" ~ "Timed oral productivity and the ability to generate descriptive components of a picture of a family scene on a task requiring initiating and sustaining verbal behavior",
      scale == "Auditory Comprehension" ~ "Auditory comprehension (i.e., the ability to receive, process, and execute oral instructions of increasing syntactic complexity)",
      scale == "Naming" ~ "Word-finding ability and retrieval fluency on a confrontation naming task",
      scale == "Reading Comprehension" ~ "Reading comprehension, which the patient was shown a photograph of an object along with six printed words (five foil words and the sixth word that correctly named the object), requiring them to point to the correct word, and then presented with a photograph of a scene involving one or more people engaged in an activity with four printed sentences (three foil sentences and the fourth sentence correctly describing the photograph), requiring them to point to the correct sentence",
      scale == "Writing" ~ "On a measure of narrative writing in which the patient was shown the same colorful picture of a family scene used in the oral production test and then asked to write about the scene",
      
      scale == "Bill Payment" ~ "Performance on a bill payment task in which the patient was presented with a utility bill statement, check ledger, check, and envelope, and asked to follow a series of commands requiring oral and written responses of increasing complexity",
      TRUE ~ as.character(description)
    )
  )

table4 <-
  table4 |>
  dplyr::mutate(
    description = dplyr::case_when(
      scale ==
        "Shape Learning Immediate Recognition" ~ "Learning and recognition of visual material (abstract shapes)",
      scale ==
        "Shape Learning Delayed Recognition" ~ "Recognition of the target visual material among nontarget distractors after a delay period",
      scale ==
        "Shape Learning Percent Retention" ~ "Percentage of visual detail retained over time, scaled to how much was initially learned",
      scale ==
        "Story Learning Immediate Recall" ~ "Performance on a more complex one-trial verbal learning and recall task (story learning)",
      scale ==
        "Story Learning Delayed Recall" ~ "Delayed recall of the story details over time",
      scale ==
        "Story Learning Percent Retention" ~ "The percentage of story detail retained over time, scaled to how much was initially learned",
      TRUE ~ as.character(description)
    )
  )

table5 <-
  table5 |>
  dplyr::mutate(
    description = dplyr::case_when(
      scale ==
        "Shape Learning Immediate Recognition" ~ "Learning and recognition of visual material (abstract shapes)",
      scale ==
        "Shape Learning Delayed Recognition" ~ "Recognition of the target visual material among nontarget distractors after a delay period",
      scale ==
        "Shape Learning Percent Retention" ~ "Percentage of visual detail retained over time, scaled to how much was initially learned",
      scale ==
        "Story Learning Immediate Recall" ~ "Performance on a more complex one-trial verbal learning and recall task (story learning)",
      scale ==
        "Story Learning Delayed Recall" ~ "Delayed recall of the story details over time",
      scale ==
        "Story Learning Percent Retention" ~ "The percentage of story detail retained over time, scaled to how much was initially learned",
      TRUE ~ as.character(description)
    )
  )

table6 <-
  table6 |>
  dplyr::mutate(
    description = dplyr::case_when(
      scale ==
        "Shape Learning Immediate Recognition" ~ "Learning and recognition of visual material (abstract shapes)",
      scale ==
        "Shape Learning Delayed Recognition" ~ "Recognition of the target visual material among nontarget distractors after a delay period",
      scale ==
        "Shape Learning Percent Retention" ~ "Percentage of visual detail retained over time, scaled to how much was initially learned",
      scale ==
        "Story Learning Immediate Recall" ~ "Performance on a more complex one-trial verbal learning and recall task (story learning)",
      scale ==
        "Story Learning Delayed Recall" ~ "Delayed recall of the story details over time",
      scale ==
        "Story Learning Percent Retention" ~ "The percentage of story detail retained over time, scaled to how much was initially learned",
      TRUE ~ as.character(description)
    )
  )

table7 <-
  table7 |>
  dplyr::mutate(
    description = dplyr::case_when(
      scale ==
        "Shape Learning Immediate Recognition" ~ "Learning and recognition of visual material (abstract shapes)",
      scale ==
        "Shape Learning Delayed Recognition" ~ "Recognition of the target visual material among nontarget distractors after a delay period",
      scale ==
        "Shape Learning Percent Retention" ~ "Percentage of visual detail retained over time, scaled to how much was initially learned",
      scale ==
        "Story Learning Immediate Recall" ~ "Performance on a more complex one-trial verbal learning and recall task (story learning)",
      scale ==
        "Story Learning Delayed Recall" ~ "Delayed recall of the story details over time",
      scale ==
        "Story Learning Percent Retention" ~ "The percentage of story detail retained over time, scaled to how much was initially learned",
      TRUE ~ as.character(description)
    )
  )

table8 <-
  table8 |>
  dplyr::mutate(
    description = dplyr::case_when(
      scale ==
        "Visual Discrimination" ~ "Perceptual processing, discrimination, and pattern matching of a series of abstract images requiring close attention to visual detail",
      scale ==
        "Design Construction" ~ "Constructing and recreating abstract visual designs (tangrams) from a model using flat polygons (tans) to reproduce each stimulus",
      TRUE ~ as.character(description)
    )
  )

table9 <-
  table9 |>
  dplyr::mutate(
    description = dplyr::case_when(
      scale == "Mazes" ~ "Planning and foresight, inhibition, and psychomotor speed examined through a series of timed maze-tracing tasks of increasing difficulty",
      scale == "Word Generation" ~ "Retrieval fluency, ideational fluency, and generativity",
      scale == "Word Generation Perseverations" ~ "Self-monitoring and perseverative tendencies",
      scale %in% c("Judgment") ~ "Judgment and decision-making in everyday situations",
      scale %in% c("Categories") ~ "Concept formation and abstract reasoning",
      TRUE ~ as.character(description)
    )
  )
```

## Glue Results

```{r}
table1 <-
  table1 |>
  dplyr::mutate(
    result = dplyr::case_when(
      scale ==
        "Total NAB Index (T-NAB)" ~ glue::glue(
        "{description} fell in the {range} range.\n"
      ),
      scale ==
        "Attention Index (ATT)" ~ glue::glue(
        "{description} was {range}.\n"
      ),
      scale ==
        "Language Index (LAN)" ~ glue::glue(
        "{description} fell in the {range} classification range.\n"
      ),
      scale ==
        "Memory Index (MEM)" ~ glue::glue(
        "{description} was {range}.\n"
      ),
      scale ==
        "Spatial Index (SPT)" ~ glue::glue(
        "{description} fell in the {range} classification range.\n"
      ),
      scale ==
        "Executive Functions Index (EXE)" ~ glue::glue(
        "{description} fell in the {range} range.\n"
      ),
      TRUE ~ as.character(result)
    )
  )

table2 <-
  table2 |>
  dplyr::mutate(
    result = dplyr::case_when(
      scale ==
        "Orientation" ~ glue::glue("{description} was intact.\n"),
      scale ==
        "Digits Forward" ~ glue::glue("{description} fell within the {range}.\n"),
      scale ==
        "Digits Forward Longest Span" ~ glue::glue("{description} was {range} ({raw_score} digits forward).\n"),
      scale ==
        "Digits Backward" ~ glue::glue("{description} fell within the {range}.\n"),
      scale ==
        "Digits Backward Longest Span" ~ glue::glue("{description} was {range} ({raw_score} digits backward).\n\n"),
      
      scale == "Numbers & Letters Part A Speed" ~ glue::glue("{description} fell within the {range}.\n\n"),
      scale == "Numbers & Letters Part A Errors" ~ glue::glue("{description} fell within the {range}.\n\n"),
      scale == "Numbers & Letters Part A Efficiency" ~ glue::glue("{description} was {range}.\n"),
      scale == "Numbers & Letters Part B Efficiency" ~ glue::glue("{description} was {range}.\n"),
      scale == "Numbers & Letters Part C Efficiency" ~ glue::glue("{description} fell within the {range}.\n\n"),
      scale == "Numbers & Letters Part D Efficiency" ~ glue::glue("{description} fell within the {range}.\n\n"),      
      scale == "Dots" ~ glue::glue("{description} fell within the {range}.\n\n"),
      scale == "Driving Scences" ~ glue::glue("{description} fell within the {range}.\n\n"),
      TRUE ~ as.character(result)
    )
  )

table3 <-
  table3 |>
  dplyr::mutate(
    result = dplyr::case_when(
      scale == "Oral Expression" ~ glue::glue("{description} was {range}.\n\n"),
      scale == "Auditory Comprehension" ~ glue::glue("{description} was {range}.\n\n"),
      scale == "Naming" ~ glue::glue("{description} was {range}, with no obvious dysfluency in conversational/informal expression.\n\n"),
      scale == "Reading Comprehension" ~ glue::glue("{description} was {range}.\n\n"),
      scale == "Writing" ~ glue::glue("{description} performance was {range} in terms of writing legibility, spelling, and syntax, but {range} for conveyance.\n\n"),
      scale == "Bill Payment" ~ glue::glue("{description} fell within the {range}.\n\n"),
      TRUE ~ as.character(result)
    )
  )

table4 <-
  table4 |>
  dplyr::mutate(
    result = dplyr::case_when(
      scale %in% c("List Learning") ~ glue::glue("{description} was {range}.\n\n"),
      scale %in% c("Shape Learning") ~ glue::glue("{description} was {range}.\n\n"),
      scale %in% c("Story Learning") ~ glue::glue("{description} was {range}.\n\n"),
      scale %in% c("Daily Living") ~ glue::glue("{description} was {range}.\n\n"),
      TRUE ~ as.character(result)
    )
  )

table5 <-
  table5 |>
  dplyr::mutate(
    result = dplyr::case_when(
      scale %in% c("List Learning") ~ glue::glue("{description} was {range}.\n\n"),
      scale %in% c("Shape Learning") ~ glue::glue("{description} was {range}.\n\n"),
      scale %in% c("Story Learning") ~ glue::glue("{description} was {range}.\n\n"),
      scale %in% c("Daily Living") ~ glue::glue("{description} was {range}.\n\n"),
      TRUE ~ as.character(result)
    )
  )

table6 <-
  table6 |>
  dplyr::mutate(
    result = dplyr::case_when(
      scale %in% c("List Learning") ~ glue::glue("{description} was {range}.\n\n"),
      scale %in% c("Shape Learning") ~ glue::glue("{description} was {range}.\n\n"),
      scale %in% c("Story Learning") ~ glue::glue("{description} was {range}.\n\n"),
      scale %in% c("Daily Living") ~ glue::glue("{description} was {range}.\n\n"),
      TRUE ~ as.character(result)
    )
  )

table7 <-
  table7 |>
  dplyr::mutate(
    result = dplyr::case_when(
      scale %in% c("Daily Living") ~ glue::glue("{description} was {range}.\n\n"),
      TRUE ~ as.character(result)
    )
  )

table8 <-
  table8 |>
  dplyr::mutate(
    result = dplyr::case_when(
      scale == "Visual Discrimination" ~ glue::glue("{description} was {range}.\n\n"),
      scale == "Design Construction" ~ glue::glue("{description} fell in the {range} range.\n\n"),
      scale %in% c("Figure") ~ glue::glue("{description} fell in the {range} range.\n\n"),
      scale %in% c("Map") ~ glue::glue("{description} was {range}.\n\n"),
      TRUE ~ as.character(result)
    )
  )

table9 <-
  table9 |>
  dplyr::mutate(
    result = dplyr::case_when(
      scale == "Mazes" ~ glue::glue("{description} fell in the {range} range.\n"),
      scale == "Word Generation" ~ glue::glue("{description} was {range}.\n\n"),
      scale == "Word Generation Perseverations" ~ glue::glue("{description} was {range}.\n"),
      scale %in% c("Judgment") ~ glue::glue("{description} fell in the {range} range.\n"),
      scale %in% c("Categories") ~ glue::glue("{description} fell in the {range} range.\n\n"),
      TRUE ~ as.character(result)
    )
  )

```

## Merge

```{r}
if (params$test == "nab") {
  df <- df |> dplyr::bind_rows(table1:table9)
  nab <- df
} else if (params$test == "nabs") {
  df <- df |> dplyr::bind_rows(table1:table6)
  nabs <- df
} else if (params$test == "nab_main") {
  df <- df |> dplyr::bind_rows(table1:table9)
  nab_main <- df
}
```

## Sort

```{r eval=F}

# Concatenate the indices into a single vector
row_indices <- c(6, 1, 7, 12:19, 2, 20, 24, 3, 27:32, 4, 33:34, 5, 35:37)
# Use slice to select the rows by these indices
nabs <- nabs |>
  dplyr::slice(row_indices)

# Concatenate the indices into a single vector
row_indices <- c(6, 1, 7, 12:19, 2, 20, 24, 3, 27:32, 4, 33:34, 5, 35:37)
# Use slice to select the rows by these indices
nabs <- nabs |>
  dplyr::slice(row_indices)

# Concatenate the indices into a single vector
row_indices <- c(6, 1, 7, 12:19, 2, 20, 24, 3, 27:32, 4, 33:34, 5, 35:37)
# Use slice to select the rows by these indices
nabs <- nabs |>
  dplyr::slice(row_indices)
```

## 95% CI

```{r eval=F}
library(bwu)

df <- nabs

# Assuming df is your dataframe and calc_ci_95 is your function
for (i in seq_len(df)) {
  ci_values <- calc_ci_95(
    ability_score = df$score[i],
    mean = 50,
    standard_deviation = 10,
    reliability = .85
  )
  df$true_score[i] <- paste0(ci_values["true_score"])
  df$ci_lo[i] <- paste0(ci_values["lower_ci_95"])
  df$ci_hi[i] <- paste0(ci_values["upper_ci_95"])
  df$ci[i] <- paste0(ci_values["lower_ci_95"], " - ", ci_values["upper_ci_95"])
}
```

## Save

```{r}
library(readr)

df <- nab
readr::write_excel_csv(df, here::here("data", "csv", "nab.csv"), col_names = TRUE, na = "")

if (any(is.na(nab$percentile))) {
  stop("STOP!!! NA value found in percentile column. Please fill in missing values.")
}
```

## "g" version 2

```{r}
table <- params$test
g <- "g2"
file_path <- here::here("data", paste0(g, ".csv"))
readr::write_excel_csv(g, here::here("data", "g2.csv"), append = TRUE, na = "")
```
