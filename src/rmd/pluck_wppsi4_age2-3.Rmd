---
title: "Pluck Tables from\nWPPSI-IV: Ages 2-3"
params:
  patient: Leo
  test: wppsi4
  test_name: "WPPSI-IV"
  version: "WPPSI-IV: Ages 2-3"
  file:
    label: "No file selected"
    value: file
    input: file
  pages: [2, 3, 5]
  table1:
    label: "Scaled Score Summary"
    value: ""
    input: select
    multiple: yes
    choices:
      - Receptive Vocabulary
      - Information
      - Picture Naming
      - Block Design
      - Object Assembly
      - Picture Memory
      - Zoo Locations
  table2:
    label: "Composite Score Summary"
    value: ["Verbal Comprehension (VCI)"]
    input: select
    multiple: yes
    choices:
      - Verbal Comprehension (VCI)
      - Visual Spatial (VSI)
      - Working Memory (WMI)
      - Full Scale IQ (FSIQ)
  table3:
    label: "Composite Ancillary Summary"
    value: ["Vocabulary Acquisition (VAI)"]
    input: select
    multiple: yes
    choices:
      - Vocabulary Acquisition (VAI)
      - Nonverbal (NVI)
      - General Ability (GAI)
  names_df1:
    label: "Table 1 Column Names"
    value: [scale, abbrev, raw_score, score, percentile, age_equiv, sem]
    input: select
    multiple: yes
    choices:
      - scale
      - abbrev
      - raw_score
      - score
      - percentile
      - age_equiv
      - sem
  names_df2:
    label: "Tables 2 and 3 Column Names"
    value: [scale, abbrev, raw_score, score, percentile, ci_95, category, sem]
    input: select
    multiple: yes
    choices:
      - scale
      - abbrev
      - raw_score
      - score
      - percentile
      - ci_95
      - category
      - sem
  keep1:
    label: "Variables to Keep, Set 1"
    value: [scale, raw_score, score, percentile]
    input: select
    multiple: yes
    choices:
      - scale
      - raw_score
      - score
      - percentile
  keep2:
    label: "Variables to Keep, Set 2"
    value: [scale, raw_score, score, percentile, ci_95]
    input: select
    multiple: yes
    choices:
      - scale
      - raw_score
      - score
      - percentile
      - ci_95
# data.frames to extract or not
  eval_df1:
    label: "Subtest Scores"
    value: TRUE
  eval_df2:
    label: "Primary Index Scores"
    value: TRUE
  eval_df3:
    label: "Supplemental Index Scores"
    value: TRUE
  match:
    label: "Subset/Match Rows"
    input: checkbox
    value: FALSE
output:
  rmdformats::robobook:
    highlight: kate
---

# WPPSI-IV

## Load libraries

```{r setup, include = FALSE}
Sys.setenv(
  JAVA_HOME =
    "/Library/Java/JavaVirtualMachines/temurin-11.jdk/Contents/Home"
)
# Sys.setenv(DYLD_LIBRARY_PATH = "Library/Java/JavaVirtualMachines/temurin-11.jdk/Contents/Home/lib/server")
options(java.parameters = "-Xmx16000m")
knitr::opts_chunk$set(
  root.dir = normalizePath("./"),
  echo = TRUE,
  message = TRUE,
  warning = FALSE,
  error = TRUE
)
library(dplyr)
library(hablar)
library(here)
library(knitr)
library(magrittr)
library(miniUI)
library(readr)
library(rmarkdown)
library(rmdformats)
library(shiny)
library(snakecase)
library(tabulapdf)
library(tibble)
library(tidyr)
library(bwu)
```

## Patient

```{r patient}
patient <- params$patient
```

## Test

```{r test}
test <- params$test
test_name <- params$test_name
version <- params$version
```

## Upload/attach PDF

```{r choose, eval = FALSE}
file <- file.path(params$file)
```

## Pages

```{r pages}
pages <- params$pages
eval_df1 <- params$eval_df1
eval_df2 <- params$eval_df2
eval_df3 <- params$eval_df3
```

## Extract Areas with tabulapdf

```{r extract-areas, eval = FALSE}

f <- file.path("/Users/joey/reports/Leo/pdf/Leo 3_8 yo ASD-2d0f9f88-433a-4fa7-8b39-5f6301683d09.pdf")

#file <- file.path(file.choose(""))

# using extract areas for now
extracted_areas <- tabulapdf::extract_areas(
  file = f,
  pages = pages,
  output = "matrix",
  resolution = 96L,
  copy = TRUE
)

# locate areas
areas_wppsi4 <- tabulapdf::locate_areas(
  file = f,
  pages = c(2, 3, 5),
  resolution = 96L,
)

```

```{r loopdf, eval = TRUE}
# Loop over the list and write each matrix to a CSV file
for (i in seq_along(extracted_areas)) {
  write.csv(extracted_areas[[i]], file = paste0(test, "_", i, ".csv"), row.names = FALSE)
}

# Save the entire list to an R data file
save(extracted_areas, file = "wppsi4_tables.RData")
```

```{r}
# Load the entire list from an R data file
load("wppsi4_tables.RData")
```

## Areas

```{r areas-known, eval = T}
# if known
# this is for wppsi4 ages 2-3, need to update for ages 4-7
if (params$version == "WPPSI-IV: Ages 2-3") {
  areas <- list(
    subtest = c(164, 52, 276, 558),
    composite = c(176, 53, 237, 559),
    ancillary = c(176, 53, 226, 559)
  )
} else {
  areas <- list(
    vci = c(168, 50, 189, 560), # todo
    pri = c(238, 50, 260, 560), # todo
    wmi = c(308, 50, 329, 560), # todo
    psi = c(376, 50, 402, 560) # todo
  )
}
```

## Extract tables

```{r extract-tables, eval = T}
plucked_tables <- bwu::gpluck_extract_table(
  file = file,
  pages = pages,
  area = areas,
  guess = "FALSE",
  method = "stream",
  output = "matrix"
)
```

```{r loopdf2, eval = TRUE}
# Loop over the list and write each matrix to a CSV file
for (i in seq_along(plucked_tables)) {
  write.csv(plucked_tables[[i]], file = paste0(test, "_", i, "_v2",".csv"), row.names = FALSE)
}

# Save the entire list to an R data file
save(plucked_tables, file = "wppsi4_tables_v2.RData")
```

```{r}
# Load the entire list from an R data file
load("wppsi4_tables_v2.RData")
```

# WPPSI-IV Subtest Scores (Table 1)

## Pluck and tidy tables

```{r pluck1, eval = T}
# Use this because it imports as a tibble
table1 <- readr::read_csv("wppsi4_1.csv")
table2 <- readr::read_csv("wppsi4_2.csv")
table3 <- readr::read_csv("wppsi4_3.csv")

# Rename columns
colnames1 <- params[["names_df1"]]
colnames(table1) <- colnames1

colnames2 <- params[["names_df2"]]
colnames(table2) <- colnames2

colnames3 <- params[["names_df2"]]
colnames(table3) <- colnames3

# Create new scale column
table2 <- table2 |>
  mutate(scale = paste0(scale, " (", abbrev, ")"))

table3 <- table3 |>
  mutate(scale = paste0(scale, " (", abbrev, ")"))
```

## Merge tables

```{r rbind}
df <- bind_rows(table2, table3, table1) |> 
  dplyr::select(all_of(params$keep2)) |> 
  dplyr::filter(!is.na(score))
```

## Merge with lookup table

```{r}
# Read the lookup table
lookup_wppsi4 <- vroom::vroom("data/lookup_wppsi4_ages2-3.csv")

# Merge the tables
df <- df |> 
  dplyr::left_join(lookup_wppsi4, by = "scale")
```

## Mutate columns

```{r mutate01, eval = params$eval_df1}
table1 <- bwu::gpluck_make_columns(
  table1,
  range = "",
  ci_95 = "",
  # test = params$test,
  # test_name = params$test_name,
  # domain = "",
  # subdomain = "",
  # narrow = "",
  # pass = "",
  # verbal = "",
  # timed = "",
  # test_type = "npsych_test",
  # score_type = "scaled_score",
  # description = "",
  result = ""
)
```

## Test score ranges

```{r range01, eval = params$eval_df1}
table1 <- bwu::gpluck_make_score_ranges(
  table = table1,
  test_type = "npsych_test"
  )
```

## Glue results

```{r result01, eval = TRUE}
table2 <-
  table2 |>
  dplyr::mutate(
    result = dplyr::case_when(
      scale == "Full Scale (FSIQ)" ~ glue::glue("{description} was {range} overall.\n"),
      scale == "General Ability (GAI)" ~ glue::glue("{description} was {range} and ranked at the {percentile}th percentile, indicating performance as good as or better than {percentile}% of same-age peers from the general population.\n"),
      scale == "Verbal Comprehension (VCI)" ~ glue::glue("{description} was classified as {range} and ranked at the {percentile}th percentile.\n"),
      scale == "Visual Spatial (VSI)" ~ glue::glue("{description} was classified as {range} and ranked at the {percentile}th percentile.\n"),
      scale == "Fluid Reasoning (FRI)" ~ glue::glue("{description} was classified as {range} and ranked at the {percentile}th percentile.\n"),
      scale == "Working Memory (WMI)" ~ glue::glue("{description} fell in the {range} range.\n"),
      scale == "Processing Speed (PSI)" ~ glue::glue("{description} was {range}.\n"),
      TRUE ~ as.character(result)
    )
  )
```

## Domains

DELETE THIS CELL

```{r domain01, eval = params$eval_df1}
table1 <-
  table1 |>
  dplyr::mutate(
    domain = dplyr::case_when(
      # ages 2-3
      scale == "Receptive Vocabulary" ~ "Verbal/Language",
      scale == "Information" ~ "Verbal/Language",
      scale == "Picture Naming" ~ "Verbal/Language",
      scale == "Block Design" ~ "Visual Perception/Construction",
      scale == "Object Assembly" ~ "Visual Perception/Construction",
      scale == "Picture Memory" ~ "Attention/Executive",
      scale == "Zoo Locations" ~ "Attention/Executive",
      # ages 4-7
      scale == "Similarities" ~ "Verbal/Language",
      scale == "Vocabulary" ~ "Verbal/Language",
      scale == "Comprehension" ~ "Verbal/Language",
      scale == "Matrix Reasoning" ~ "Visual Perception/Construction",
      scale == "Picture Concepts" ~ "Visual Perception/Construction",
      scale == "Bug Search" ~ "Attention/Executive",
      scale == "Cancellation" ~ "Attention/Executive",
      scale == "Animal Coding" ~ "Attention/Executive",
      TRUE ~ as.character(domain)
    )
  )
```

## Subdomains

```{r subdomain01, eval = params$eval_df1}
table1 <-
  table1 |>
  dplyr::mutate(
    subdomain = dplyr::case_when(
      scale == "Receptive Vocabulary" ~ "Knowledge",
      scale == "Information" ~ "Knowledge",
      scale == "Picture Naming" ~ "Retrieval",
      scale == "Block Design" ~ "Construction",
      scale == "Object Assembly" ~ "Construction",
      scale == "Picture Memory" ~ "Working Memory",
      scale == "Zoo Locations" ~ "Working Memory",
      
      scale == "Similarities" ~ "Reasoning",
      scale == "Vocabulary" ~ "Knowledge",
      scale == "Comprehension" ~ "Listening Ability",
      scale == "Matrix Reasoning" ~ "Reasoning",
      scale == "Picture Concepts" ~ "Reasoning",
      scale == "Bug Search" ~ "Processing Speed",
      scale == "Cancellation" ~ "Attention",
      scale == "Animal Coding" ~ "Processing Speed",
      TRUE ~ as.character(subdomain)
    )
  )
```

## Narrow subdomain

```{r narrow01, eval = params$eval_df1}
table1 <-
  table1 |>
  dplyr::mutate(
    narrow = dplyr::case_when(
      scale == "Receptive Vocabulary" ~ "Word Knowledge",
      scale == "Information" ~ "World Knowledge",
      scale == "Picture Naming" ~ "Word Retrieval",
      scale == "Block Design" ~ "Design Construction",
      scale == "Object Assembly" ~ "Puzzle Construction",
      scale == "Picture Memory" ~ "Visual Memory",
      scale == "Zoo Locations" ~ "Working Memory",
      # todo: ages 4-7
      scale == "Similarities" ~ "Reasoning",
      scale == "Vocabulary" ~ "Knowledge",
      scale == "Comprehension" ~ "Listening Ability",
      scale == "Matrix Reasoning" ~ "Reasoning",
      scale == "Picture Concepts" ~ "Reasoning",
      scale == "Bug Search" ~ "Processing Speed",
      scale == "Cancellation" ~ "Attention",
      scale == "Animal Coding" ~ "Processing Speed",
      TRUE ~ as.character(narrow)
    )
  )
```

## PASS model

```{r pass01, eval = params$eval_df1}
table1 <-
  table1 |>
  dplyr::mutate(
    pass = dplyr::case_when(
      scale == "Receptive Vocabulary" ~ "Knowledge",
      scale == "Information" ~ "Knowledge",
      scale == "Picture Naming" ~ "Simultaneous",
      scale == "Block Design" ~ "Simultaneous",
      scale == "Object Assembly" ~ "Simultaneous",
      scale == "Picture Memory" ~ "Simultaneous",
      scale == "Zoo Locations" ~ "Attention",
      TRUE ~ as.character(pass)
    )
  )
```

## Verbal vs Nonverbal

```{r verbal01, eval = params$eval_df1}
table1 <-
  table1 |>
  dplyr::mutate(
    verbal = dplyr::case_when(
      scale == "Receptive Vocabulary" ~ "Verbal",
      scale == "Information" ~ "Verbal",
      scale == "Picture Naming" ~ "Verbal",
      scale == "Block Design" ~ "Nonverbal",
      scale == "Object Assembly" ~ "Nonverbal",
      scale == "Picture Memory" ~ "",
      scale == "Zoo Locations" ~ "Nonverbal",
      # todo: ages 4-7
      scale == "Similarities" ~ "Reasoning",
      scale == "Vocabulary" ~ "Knowledge",
      scale == "Comprehension" ~ "Listening Ability",
      scale == "Matrix Reasoning" ~ "Reasoning",
      scale == "Picture Concepts" ~ "Reasoning",
      scale == "Bug Search" ~ "Processing Speed",
      scale == "Cancellation" ~ "Attention",
      scale == "Animal Coding" ~ "Processing Speed",
      TRUE ~ as.character(verbal)
    )
  )
```

## Timed vs Untimed

```{r timed01, eval = params$eval_df1}
table1 <-
  table1 |>
  dplyr::mutate(
    timed = dplyr::case_when(
      scale == "Receptive Vocabulary" ~ "Untimed",
      scale == "Information" ~ "FALSE",
      scale == "Picture Naming" ~ "",
      scale == "Block Design" ~ "TRUE",
      scale == "Object Assembly" ~ "TRUE",
      scale == "Picture Memory" ~ "FALSE",
      scale == "Zoo Locations" ~ "FALSE",

      scale == "Animal Coding" ~ "TRUE",
      scale == "Bug Search" ~ "TRUE",
      scale == "Cancellation" ~ "TRUE",
      scale == "Comprehension" ~ "FALSE",
      scale == "Matrix Reasoning" ~ "FALSE",
      scale == "Picture Concepts" ~ "FALSE",
      scale == "Similarities" ~ "FALSE",
      scale == "Vocabulary" ~ "FALSE",
      TRUE ~ as.character(timed)
    )
  )
```

## Descriptions

```{r desc01, eval = params$eval_df1}

describe_subtest <- function(subtest) {
  description <- switch(subtest,
    "Receptive Vocabulary" = "This subtest measures the child's ability to understand and use words.",
    "Information" = "This subtest measures the child's general knowledge and ability to recall and understand information.",
    "Picture Naming" = "This subtest measures the child's ability to name objects and actions.",
    "Block Design" = "This subtest measures the child's ability to analyze and synthesize abstract visual stimuli unfamiliar to the child.",
    "Object Assembly" = "This subtest measures the child's ability to analyze and synthesize abstract visual stimuli using familiar puzzles.",
    "Picture Memory" = "This subtest measures the child's ability to remember and recall visual information.",
    "Zoo Locations" = "This subtest measures the child's ability to understand and use spatial concepts temporarily stored in working memory."
  )
  return(description)
}


table2 <-
  table2 |>
  dplyr::mutate(
    description = dplyr::case_when(
      scale ==
        "Full Scale IQ" ~ "General Intelligence (*g*)",
      scale ==
        "General Ability (GAI)" ~ "A subset of intellectual functioning with reduced influences of working memory and processing speed",
      scale ==
        "Verbal Comprehension (VCI)" ~ "Verbal Comprehension (i.e., the ability to verbalize meaningful concepts, think about verbal information, and express oneself using words)",
      scale ==
        "Perceptual Reasoning (PRI)" ~ "Fluid Reasoning (i.e., the ability to use reasoning to identify and apply solutions to problems)",
      scale ==
        "Working Memory (WMI)" ~ "Working Memory (*G*wm)",
      scale ==
        "Processing Speed (PSI)" ~ "Processing Speed (*G*s)",

      scale == "Receptive Vocabulary" ~ "Knowledge",
      scale == "Information" ~ "Knowledge",
      scale == "Picture Naming" ~ "Retrieval",
      scale == "Block Design" ~ "Construction",
      scale == "Object Assembly" ~ "Construction",
      scale == "Picture Memory" ~ "Working Memory",
      scale == "Zoo Locations" ~ "Working Memory",
      
      scale == "Similarities" ~ "Reasoning",
      scale == "Vocabulary" ~ "Knowledge",
      scale == "Comprehension" ~ "Listening Ability",
      scale == "Matrix Reasoning" ~ "Reasoning",
      scale == "Picture Concepts" ~ "Reasoning",
      scale == "Bug Search" ~ "Processing Speed",
      scale == "Cancellation" ~ "Attention",
      scale == "Animal Coding" ~ "Processing Speed",

      TRUE ~ as.character(description)
    )
  )
```

# WPPSI-IV Primary Composite Scores (Table 2)

## Domain

```{r domain02}
table2 <-
  table2 |>
  dplyr::mutate(
    domain = dplyr::case_when(
      scale == "Verbal Comprehension (VCI)" ~ "General Cognitive Ability",
      scale == "Visual Spatial (VSI)" ~ "General Cognitive Ability",
      scale == "Working Memory (WMI)" ~ "General Cognitive Ability",
      scale == "Processing Speed (PSI)" ~ "General Cognitive Ability",
      scale == "Full Scale (FSIQ)" ~ "General Cognitive Ability",
      TRUE ~ as.character(domain)
    )
  )
```

## Subdomain

```{r subdomain02}
table2 <-
  table2 |>
  mutate(
    subdomain = case_when(
      scale == "Verbal Comprehension (VCI)" ~ "Crystallized Intelligence",
      scale == "Visual Spatial (VSI)" ~ "Fluid Intelligence",
      scale == "Fluid Reasoning (FRI)" ~ "Fluid Intelligence",
      scale == "Working Memory (WMI)" ~ "Working Memory",
      scale == "Processing Speed (PSI)" ~ "Processing Speed",
      scale == "Full Scale IQ (FSIQ)" ~ "General Intelligence",
      TRUE ~ as.character(subdomain)
    )
  )
```

## Narrow subdomain

```{r narrow02}
table2 <-
  table2 |>
  mutate(
    narrow = case_when(
      scale == "Verbal Comprehension (VCI)" ~ "Crystallized Intelligence",
      scale == "Visual Spatial (VSI)" ~ "Fluid Intelligence",
      scale == "Fluid Reasoning (FRI)" ~ "Fluid Intelligence",
      scale == "Working Memory (WMI)" ~ "Working Memory",
      scale == "Processing Speed (PSI)" ~ "Processing Speed",
      scale == "Full Scale IQ (FSIQ)" ~ "General Intelligence",
      TRUE ~ as.character(narrow)
    )
  )
```

## PASS model

```{r pass02}
table2 <-
  table2 |>
  mutate(
    pass = case_when(
      scale == "Verbal Comprehension (VCI)" ~ "Sequential",
      scale == "Visual Spatial (VSI)" ~ "Simultaneous",
      scale == "Fluid Reasoning (FRI)" ~ "Simultaneous",
      scale == "Working Memory (WMI)" ~ "Attention",
      scale == "Processing Speed (PSI)" ~ "Planning",
      scale == "Full Scale IQ (FSIQ)" ~ "PASS Total",
      TRUE ~ as.character(pass)
    )
  )
```

# WPPSI-IV Supplemental Index Scores (Table 3)

## Domains

```{r domain03}
table3 <-
  table3 |>
  mutate(
    domain = case_when(
      scale == "Vocabulary Acquisition (VAI)" ~ "General Cognitive Ability",
      scale == "Nonverbal (NVI)" ~ "General Cognitive Ability",
      scale == "General Ability (GAI)" ~ "General Cognitive Ability",
      scale == "Cognitive Proficiency (CPI)" ~ "General Cognitive Ability",
      TRUE ~ as.character(domain)
    )
  )
```

## Subdomains

```{r subdomain3, eval=F}
table3 <-
  table3 |>
  mutate(
    subdomain = case_when(
      scale == "Vocabulary Acquisition (VAI)" ~ "Crystallized Intelligence",
      scale == "Nonverbal (NVI)" ~ "Fluid Intelligence",
      scale == "General Ability (GAI)" ~ "General Ability",
      scale == "Cognitive Proficiency (CPI)" ~ "Cognitive Proficiency",
      TRUE ~ as.character(subdomain)
    )
  )
```

## Narrow subdomain

```{r narrow03, eval=F}
table3 <-
  table3 |>
  mutate(
    narrow = case_when(
      scale == "Vocabulary Acquisition (VAI)" ~ "Crystallized Intelligence",
      scale == "Nonverbal (NVI)" ~ "Fluid Intelligence",
      scale == "General Ability (GAI)" ~ "General Ability",
      scale == "Cognitive Proficiency (CPI)" ~ "Cognitive Proficiency",
      TRUE ~ as.character(narrow)
    )
  )
```

## PASS model

```{r pass03, eval=F}
table3 <-
  table3 |>
  mutate(
    pass = case_when(
      scale == "Vocabulary Acquisition (VAI)" ~ "Sequential",
      scale == "Nonverbal (NVI)" ~ "Simultaneous",
      scale == "General Ability (GAI)" ~ "Sequential/Simultaneous",
      scale == "Cognitive Proficiency (CPI)" ~ "Attention/Planning",
      TRUE ~ as.character(pass)
    )
  )
```

## Verbal vs Nonverbal

```{r verbal03, eval=F}
table3 <-
  table3 |>
  mutate(
    verbal = case_when(
      scale == "Vocabulary Acquisition (VAI)" ~ "Verbal",
      scale == "Nonverbal (NVI)" ~ "Nonverbal",
      scale == "General Ability (GAI)" ~ "Verbal/Nonverbal",
      scale == "Cognitive Proficiency (CPI)" ~ "Verbal/Nonverbal",
      TRUE ~ as.character(verbal)
    )
  )
```

## Timed vs Untimed

```{r timed3, eval=F}
table3 <-
  table3 |>
  mutate(
    timed = case_when(
      scale == "Vocabulary Acquisition (VAI)" ~ "FALSE",
      scale == "Nonverbal (NVI)" ~ "TRUE",
      scale == "General Ability (GAI)" ~ "FALSE",
      scale == "Cognitive Proficiency (CPI)" ~ "TRUE",
      TRUE ~ as.character(timed)
    )
  )
```

## Description

```{r description03, eval=F}
table3 <-
  table3 |>
  mutate(
    description = case_when(
      scale == "Vocabulary Acquisition (VAI)" ~ "vocabulary acquisition and development",
      scale == "Nonverbal (NVI)" ~ "general intellectual functioning that minimizes expressive language demands",
      scale == "General Ability (GAI)" ~ "a subset of intellectual functioning with reduced influences of working memory and processing speed",
      scale == "Cognitive Proficiency (CPI)" ~ "index of cognitive processing proficiency that reduces crystallized knowledge, verbal reasoning, and fluid reasoning demands",
      TRUE ~ as.character(description)
    )
  )
```

# Finalize

## Relocate variables

```{r, eval=F}
table1 <- table1 |> relocate(c(raw_score, score, percentile, range, ci_95), .before = test)
table2 <- table2 |> relocate(c(raw_score, score, percentile, range, ci_95), .before = test)
table3 <- table3 |> relocate(c(raw_score, score, percentile, range, ci_95), .before = test)
```

## Write out final csv

```{r write-csv}
write_csv(wppsi4, here::here(patient, "csv", "wppsi4.csv"), col_names = TRUE, na = "")
```
